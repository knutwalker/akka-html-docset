


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Routing &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Exo:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Actors" href="index-actors.html" />
    <link rel="next" title="Building Finite State Machine Actors" href="fsm.html" />
    <link rel="prev" title="Mailboxes" href="mailboxes.html" />
    <!--Google Analytics-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-21117439-1']);
      _gaq.push(['_setDomainName', 'akka.io']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })()
    </script>

  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img src="../_static/logo-small.png" /></a>
        </div>    
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://akka.io/faq">FAQ</a></li>
          <li><a href="http://typesafe.com/stack/downloads/akka">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>           
          <li><a href="http://typesafe.com/products/typesafe-subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Routing</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">           
              <li>
                 <span class="divider">|</span> <a href="fsm.html">Building Finite State Machine Actors</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../index.html">Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="mailboxes.html">Mailboxes</a> <span class="divider">|</span>
              </li>
              <li>
                Version 2.2.3
              </li>
            </ul>
          </div>
        </div>
        <div class="row">
          <div class="span9">
            <div id="cse">Loading</div>
          </div><div class="span9">
            
  <div class="section" id="routing">
<span id="routing-java"></span><h1>Routing</h1>
<p>A Router is an actor that receives messages and efficiently routes them to other actors, known as
its <em>routees</em>.</p>
<p>Different routing strategies can be used, according to your application's needs. Akka comes with
several useful routing strategies right out of the box. But, as you will see in this chapter, it is
also possible to <a class="reference internal" href="routing.html#custom-router-java"><em>create your own</em></a>.</p>
<p>The routers shipped with Akka are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">akka.routing.RoundRobinRouter</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.RandomRouter</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.SmallestMailboxRouter</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.BroadcastRouter</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.ScatterGatherFirstCompletedRouter</span></tt></li>
<li><tt class="docutils literal"><span class="pre">akka.routing.ConsistentHashingRouter</span></tt></li>
</ul>
<div class="section" id="routers-in-action">
<h2>Routers in Action</h2>
<p>Sending a message to a router is easy.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">router</span><span class="o">.</span><span class="na">tell</span><span class="o">(</span><span class="k">new</span> <span class="n">MyMsg</span><span class="o">(),</span> <span class="n">sender</span><span class="o">);</span>
</pre></div>
</div>
<p>A router actor forwards messages to its routees according to its routing policy.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In general, any message sent to a router will be sent onwards to its routees. But there are a
few exceptions. These are documented in the <a class="reference internal" href="routing.html#router-special-messages-java"><em>Handling for Special Messages</em></a> section below.</p>
</div>
<div class="section" id="creating-a-router">
<h3>Creating a Router</h3>
<p>Routers and routees are closely intertwined. Router actors are created by specifying the desired
<em>routee</em> <tt class="xref py py-class docutils literal"><span class="pre">Props</span></tt> then attaching the router's <tt class="xref py py-class docutils literal"><span class="pre">RouterConfig</span></tt>. When you create a router
actor it will create routees, as needed, as its children.</p>
<p>For example, the following code and configuration snippets show how to create a <a class="reference internal" href="routing.html#round-robin-router-java"><em>round-robin</em></a> router that forwards messages to five <tt class="docutils literal"><span class="pre">ExampleActor</span></tt> routees. The
routees will be created as the router's children.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">myrouter1</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">round</span><span class="o">-</span><span class="n">robin</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">router</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FromConfig</span><span class="o">()),</span> <span class="s">&quot;myrouter1&quot;</span><span class="o">);</span>
</pre></div>
</div>
<p>Here is the same example, but with the router configuration provided programmatically instead of
from configuration.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">int</span> <span class="n">nrOfInstances</span> <span class="k">=</span> <span class="mi">5</span><span class="o">;</span>
<span class="nc">ActorRef</span> <span class="n">router1</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="n">nrOfInstances</span><span class="o">)));</span>
</pre></div>
</div>
<p>Sometimes, rather than having the router create its routees, it is desirable to create routees
separately and provide them to the router for its use. You can do this by passing an
<tt class="xref py py-class docutils literal"><span class="pre">Iterable</span></tt> of routees to the router's configuration.</p>
<p>The example below shows how to create a router by providing it with the <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt>s of three
routee actors.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">actor1</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">));</span>
<span class="nc">ActorRef</span> <span class="n">actor2</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">));</span>
<span class="nc">ActorRef</span> <span class="n">actor3</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">));</span>
<span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&gt;</span> <span class="n">routees</span> <span class="k">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="n">asList</span><span class="o">(</span>
  <span class="k">new</span> <span class="nc">ActorRef</span><span class="o">[]</span> <span class="o">{</span> <span class="n">actor1</span><span class="o">,</span> <span class="n">actor2</span><span class="o">,</span> <span class="n">actor3</span> <span class="o">});</span>
<span class="nc">ActorRef</span> <span class="n">router2</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">empty</span><span class="o">().</span><span class="n">withRouter</span><span class="o">(</span><span class="nc">RoundRobinRouter</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">routees</span><span class="o">)));</span>
</pre></div>
</div>
<p>Routees can also be specified by providing their path strings instead of their <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt>s.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">actor1</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">),</span> <span class="s">&quot;actor1&quot;</span><span class="o">);</span>
<span class="nc">ActorRef</span> <span class="n">actor2</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">),</span> <span class="s">&quot;actor2&quot;</span><span class="o">);</span>
<span class="nc">ActorRef</span> <span class="n">actor3</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">),</span> <span class="s">&quot;actor3&quot;</span><span class="o">);</span>
<span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">routees</span> <span class="k">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="n">asList</span><span class="o">(</span>
  <span class="k">new</span> <span class="nc">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&quot;/user/actor1&quot;</span><span class="o">,</span> <span class="s">&quot;/user/actor2&quot;</span><span class="o">,</span> <span class="s">&quot;/user/actor3&quot;</span> <span class="o">});</span>
<span class="nc">ActorRef</span> <span class="n">router</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">empty</span><span class="o">().</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="n">routees</span><span class="o">)));</span>
</pre></div>
</div>
<p>In addition to being able to supply looked-up remote actors as routees, you can ask the router to
deploy its created children on a set of remote hosts. Routees will be deployed in round-robin
fashion. In order to deploy routees remotely, wrap the router configuration in a
<tt class="xref py py-class docutils literal"><span class="pre">RemoteRouterConfig</span></tt>, attaching the remote addresses of the nodes to deploy to. Remote
deployment requires the <tt class="docutils literal"><span class="pre">akka-remote</span></tt> module to be included in the classpath.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">Address</span> <span class="n">addr1</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Address</span><span class="o">(</span><span class="s">&quot;akka&quot;</span><span class="o">,</span> <span class="s">&quot;remotesys&quot;</span><span class="o">,</span> <span class="s">&quot;otherhost&quot;</span><span class="o">,</span> <span class="mi">1234</span><span class="o">);</span>
<span class="nc">Address</span> <span class="n">addr2</span> <span class="k">=</span> <span class="nc">AddressFromURIString</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="s">&quot;akka://othersys@anotherhost:1234&quot;</span><span class="o">);</span>
<span class="nc">Address</span><span class="o">[]</span> <span class="n">addresses</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Address</span><span class="o">[]</span> <span class="o">{</span> <span class="n">addr1</span><span class="o">,</span> <span class="n">addr2</span> <span class="o">};</span>
<span class="nc">ActorRef</span> <span class="n">routerRemote</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">)</span>
  <span class="o">.</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RemoteRouterConfig</span><span class="o">(</span><span class="k">new</span> <span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">addresses</span><span class="o">)));</span>
</pre></div>
</div>
<p>There are a few gotchas to be aware of when creating routers:</p>
<ul class="simple">
<li>If you define the <tt class="docutils literal"><span class="pre">router</span></tt> in the configuration file then this value will be used instead of any
programmatically provided parameters.</li>
<li>Although routers can be configured in the configuration file, they must still be created
programmatically, i.e. you cannot make a router through external configuration alone.</li>
<li>If you provide the <tt class="docutils literal"><span class="pre">routees</span></tt> in the router configuration then
the value of <tt class="docutils literal"><span class="pre">nrOfInstances</span></tt>, if provided, will be disregarded.</li>
<li>When you provide routees programmatically the router will generally ignore the routee
<tt class="xref py py-class docutils literal"><span class="pre">Props</span></tt>, as it does not need to create routees. However, if you use a <a class="reference internal" href="routing.html#resizable-routers-java"><em>resizable
router</em></a> then the routee <tt class="xref py py-class docutils literal"><span class="pre">Props</span></tt> will be used whenever the
resizer creates new routees.</li>
</ul>
</div>
<div class="section" id="routers-routees-and-senders">
<h3>Routers, Routees and Senders</h3>
<p>The router forwards messages onto its routees without changing the original sender. When a routee
replies to a routed message, the reply will be sent to the original sender, not to the router.</p>
<p>When a router creates routees, they are created as the routers children. This gives each routee its
own identity in the actor system.</p>
<p>When a routee replies it can <a class="reference internal" href="untyped-actors.html#actors-tell-sender-java"><em>set itself</em></a> as the sender of the reply.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">getSender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;reply&quot;</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span> <span class="c1">// replies go to this actor</span>
</pre></div>
</div>
<p>However, it is often useful for routees to set the <em>router</em> as the sender. For example, you might
want to set the router as the sender if you want to hide the details of the routees behind the
router. The following code snippet shows how to set the parent router as sender.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">getSender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;reply&quot;</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="n">parent</span><span class="o">());</span> <span class="c1">// replies go to router</span>
</pre></div>
</div>
<p>Note that different code would be needed if the routees were not children of the router, i.e. if
they were provided when the router was created.</p>
</div>
</div>
<div class="section" id="routers-and-supervision">
<h2>Routers and Supervision</h2>
<p>Routees can be created by a router or provided to the router when it is created. Any routees that
are created by a router will be created as the router's children. The router is therefore also the
children's supervisor.</p>
<p>The supervision strategy of the router actor can be configured with the
<tt class="xref py py-meth docutils literal"><span class="pre">RouterConfig.supervisorStrategy</span></tt> property. If no configuration is provided, routers default
to a strategy of “always escalate”. This means that errors are passed up to the router's supervisor
for handling. The router's supervisor will decide what to do about any errors.</p>
<p>Note the router's supervisor will treat the error as an error with the router itself. Therefore a
directive to stop or restart will cause the router <em>itself</em> to stop or restart. The router, in
turn, will cause its children to stop and restart.</p>
<p>It should be mentioned that the router's restart behavior has been overridden so that a restart,
while still re-creating the children, will still preserve the same number of actors in the pool.</p>
<p>This means that if you have not specified <tt class="xref py py-meth docutils literal"><span class="pre">supervisorStrategy</span></tt> of the router or its parent a
failure in a routee will escalate to the parent of the router, which will by default restart the router,
which will restart all routees (it uses Escalate and does not stop routees during restart). The reason
is to make the default behave such that adding <tt class="xref py py-meth docutils literal"><span class="pre">withRouter</span></tt> to a child’s definition does not
change the supervision strategy applied to the child. This might be an inefficiency that you can avoid
by specifying the strategy when defining the router.</p>
<p>Setting the strategy is easily done:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">SupervisorStrategy</span> <span class="n">strategy</span> <span class="k">=</span>
  <span class="k">new</span> <span class="nc">OneForOneStrategy</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;1 minute&quot;</span><span class="o">),</span>
     <span class="nc">Collections</span><span class="o">.&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="k">extends</span> <span class="nc">Throwable</span><span class="o">&gt;&gt;</span><span class="n">singletonList</span><span class="o">(</span><span class="nc">Exception</span><span class="o">.</span><span class="n">class</span><span class="o">));</span>
<span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">router</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">MyActor</span><span class="o">.</span><span class="n">class</span><span class="o">)</span>
    <span class="o">.</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">withSupervisorStrategy</span><span class="o">(</span><span class="n">strategy</span><span class="o">)));</span>
</pre></div>
</div>
<div class="admonition note" id="note-router-terminated-children-java">
<p class="first admonition-title">Note</p>
<p class="last">If the child of a router terminates, the router will not automatically spawn
a new child. In the event that all children of a router have terminated the
router will terminate itself, unless it is a dynamic router, e.g. using
a resizer.</p>
</div>
</div>
<div class="section" id="router-usage">
<h2>Router usage</h2>
<p>In this section we will describe how to use the different router types.
First we need to create some actors that will be used in the examples:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">PrintlnActor</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;Received message &#39;%s&#39; in actor %s&quot;</span><span class="o">,</span>
      <span class="n">msg</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">().</span><span class="n">path</span><span class="o">().</span><span class="n">name</span><span class="o">()));</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">FibonacciActor</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="n">instanceof</span> <span class="nc">FibonacciNumber</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">FibonacciNumber</span> <span class="n">fibonacciNumber</span> <span class="k">=</span> <span class="o">(</span><span class="nc">FibonacciNumber</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
      <span class="n">getSender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="n">fibonacci</span><span class="o">(</span><span class="n">fibonacciNumber</span><span class="o">.</span><span class="n">getNbr</span><span class="o">()),</span> <span class="n">getSelf</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">unhandled</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="n">int</span> <span class="n">fibonacci</span><span class="o">(</span><span class="n">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="n">int</span> <span class="n">fib</span><span class="o">(</span><span class="n">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">int</span> <span class="n">b</span><span class="o">,</span> <span class="n">int</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
      <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
    <span class="c1">// recursion</span>
    <span class="k">return</span> <span class="n">fib</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="n">static</span> <span class="k">class</span> <span class="nc">FibonacciNumber</span> <span class="n">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="k">private</span> <span class="n">static</span> <span class="k">final</span> <span class="n">long</span> <span class="n">serialVersionUID</span> <span class="k">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="k">private</span> <span class="k">final</span> <span class="n">int</span> <span class="n">nbr</span><span class="o">;</span>

    <span class="n">public</span> <span class="nc">FibonacciNumber</span><span class="o">(</span><span class="n">int</span> <span class="n">nbr</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="n">nbr</span> <span class="k">=</span> <span class="n">nbr</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">public</span> <span class="n">int</span> <span class="n">getNbr</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">nbr</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="roundrobinrouter">
<span id="round-robin-router-java"></span><h3>RoundRobinRouter</h3>
<p>Routes in a <a class="reference external" href="http://en.wikipedia.org/wiki/Round-robin">round-robin</a> fashion to its routees.
Code example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">roundRobinRouter</span> <span class="k">=</span> <span class="n">getContext</span><span class="o">().</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">PrintlnActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="mi">5</span><span class="o">)),</span>
  <span class="s">&quot;router&quot;</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="n">int</span> <span class="n">i</span> <span class="k">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
  <span class="n">roundRobinRouter</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
</div>
<p>When run you should see a similar output to this:</p>
<div class="highlight-scala"><pre>Received message '1' in actor $b
Received message '2' in actor $c
Received message '3' in actor $d
Received message '6' in actor $b
Received message '4' in actor $e
Received message '8' in actor $d
Received message '5' in actor $f
Received message '9' in actor $e
Received message '10' in actor $f
Received message '7' in actor $c</pre>
</div>
<p>If you look closely to the output you can see that each of the routees received two messages which
is exactly what you would expect from a round-robin router to happen.
(The name of an actor is automatically created in the format <tt class="docutils literal"><span class="pre">$letter</span></tt> unless you specify it -
hence the names printed above.)</p>
<p>This is an example of how to define a round-robin router in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">myrouter1</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">round</span><span class="o">-</span><span class="n">robin</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="randomrouter">
<h3>RandomRouter</h3>
<p>As the name implies this router type selects one of its routees randomly and forwards
the message it receives to this routee.
This procedure will happen each time it receives a message.
Code example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">randomRouter</span> <span class="k">=</span> <span class="n">getContext</span><span class="o">().</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">PrintlnActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RandomRouter</span><span class="o">(</span><span class="mi">5</span><span class="o">)),</span>
    <span class="s">&quot;router&quot;</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="n">int</span> <span class="n">i</span> <span class="k">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
  <span class="n">randomRouter</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
</div>
<p>When run you should see a similar output to this:</p>
<div class="highlight-scala"><pre>Received message '1' in actor $e
Received message '2' in actor $c
Received message '4' in actor $b
Received message '5' in actor $d
Received message '3' in actor $e
Received message '6' in actor $c
Received message '7' in actor $d
Received message '8' in actor $e
Received message '9' in actor $d
Received message '10' in actor $d</pre>
</div>
<p>The result from running the random router should be different, or at least random, every time you run it.
Try to run it a couple of times to verify its behavior if you don't trust us.</p>
<p>This is an example of how to define a random router in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">myrouter3</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">random</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="smallestmailboxrouter">
<h3>SmallestMailboxRouter</h3>
<p>A Router that tries to send to the non-suspended routee with fewest messages in mailbox.
The selection is done in this order:</p>
<blockquote>
<div><ul class="simple">
<li>pick any idle routee (not processing message) with empty mailbox</li>
<li>pick any routee with empty mailbox</li>
<li>pick routee with fewest pending messages in mailbox</li>
<li>pick any remote routee, remote actors are consider lowest priority,
since their mailbox size is unknown</li>
</ul>
</div></blockquote>
<p>Code example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">smallestMailboxRouter</span> <span class="k">=</span> <span class="n">getContext</span><span class="o">().</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">PrintlnActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">SmallestMailboxRouter</span><span class="o">(</span><span class="mi">5</span><span class="o">)),</span>
  <span class="s">&quot;router&quot;</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="n">int</span> <span class="n">i</span> <span class="k">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
  <span class="n">smallestMailboxRouter</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This is an example of how to define a smallest-mailbox router in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">myrouter4</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">smallest</span><span class="o">-</span><span class="n">mailbox</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="broadcastrouter">
<h3>BroadcastRouter</h3>
<p>A broadcast router forwards the message it receives to <em>all</em> its routees.
Code example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">broadcastRouter</span> <span class="k">=</span> <span class="n">getContext</span><span class="o">().</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">PrintlnActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">BroadcastRouter</span><span class="o">(</span><span class="mi">5</span><span class="o">)),</span> <span class="s">&quot;router&quot;</span><span class="o">);</span>
<span class="n">broadcastRouter</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;this is a broadcast message&quot;</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
</pre></div>
</div>
<p>When run you should see a similar output to this:</p>
<div class="highlight-scala"><pre>Received message 'this is a broadcast message' in actor $f
Received message 'this is a broadcast message' in actor $d
Received message 'this is a broadcast message' in actor $e
Received message 'this is a broadcast message' in actor $c
Received message 'this is a broadcast message' in actor $b</pre>
</div>
<p>As you can see here above each of the routees, five in total, received the broadcast message.</p>
<p>This is an example of how to define a broadcast router in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">myrouter5</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">broadcast</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Broadcast routers always broadcast <em>every</em> message to their routees. If you do not want to
broadcast every message, then you can use a non-broadcasting router and use
<a class="reference internal" href="routing.html#broadcast-messages-java"><em>Broadcast Messages</em></a> as needed.</p>
</div>
</div>
<div class="section" id="scattergatherfirstcompletedrouter">
<h3>ScatterGatherFirstCompletedRouter</h3>
<p>The ScatterGatherFirstCompletedRouter will send the message on to all its routees as a future.
It then waits for first result it gets back. This result will be sent back to original sender.
Code example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">scatterGatherFirstCompletedRouter</span> <span class="k">=</span> <span class="n">getContext</span><span class="o">().</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">FibonacciActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">ScatterGatherFirstCompletedRouter</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&quot;seconds&quot;</span><span class="o">))),</span>
  <span class="s">&quot;router&quot;</span><span class="o">);</span>
<span class="nc">Timeout</span> <span class="n">timeout</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Timeout</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">&quot;seconds&quot;</span><span class="o">));</span>
<span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">futureResult</span> <span class="k">=</span> <span class="n">akka</span><span class="o">.</span><span class="n">pattern</span><span class="o">.</span><span class="nc">Patterns</span><span class="o">.</span><span class="n">ask</span><span class="o">(</span>
  <span class="n">scatterGatherFirstCompletedRouter</span><span class="o">,</span> <span class="k">new</span> <span class="nc">FibonacciActor</span><span class="o">.</span><span class="nc">FibonacciNumber</span><span class="o">(</span><span class="mi">10</span><span class="o">),</span>
  <span class="n">timeout</span><span class="o">);</span>
<span class="n">int</span> <span class="n">result</span> <span class="k">=</span> <span class="o">(</span><span class="nc">Integer</span><span class="o">)</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">futureResult</span><span class="o">,</span> <span class="n">timeout</span><span class="o">.</span><span class="n">duration</span><span class="o">());</span>
</pre></div>
</div>
<p>When run you should see this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">The</span> <span class="n">result</span> <span class="n">of</span> <span class="n">calculating</span> <span class="nc">Fibonacci</span> <span class="k">for</span> <span class="mi">10</span> <span class="n">is</span> <span class="mi">55</span>
</pre></div>
</div>
<p>From the output above you can't really see that all the routees performed the calculation, but they did!
The result you see is from the first routee that returned its calculation to the router.</p>
<p>This is an example of how to define a scatter-gather router in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">myrouter6</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">scatter</span><span class="o">-</span><span class="n">gather</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">within</span> <span class="k">=</span> <span class="mi">10</span> <span class="n">seconds</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="consistenthashingrouter">
<h3>ConsistentHashingRouter</h3>
<p>The ConsistentHashingRouter uses <a class="reference external" href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a>
to select a connection based on the sent message. This
<a class="reference external" href="http://weblogs.java.net/blog/tomwhite/archive/2007/11/consistent_hash.html">article</a> gives good
insight into how consistent hashing is implemented.</p>
<p>There is 3 ways to define what data to use for the consistent hash key.</p>
<ul class="simple">
<li>You can define <tt class="docutils literal"><span class="pre">withHashMapper</span></tt> of the router to map incoming
messages to their consistent hash key. This makes the the decision
transparent for the sender.</li>
<li>The messages may implement <tt class="docutils literal"><span class="pre">akka.routing.ConsistentHashingRouter.ConsistentHashable</span></tt>.
The key is part of the message and it's convenient to define it together
with the message definition.</li>
<li>The messages can be be wrapped in a <tt class="docutils literal"><span class="pre">akka.routing.ConsistentHashingRouter.ConsistentHashableEnvelope</span></tt>
to define what data to use for the consistent hash key. The sender knows
the key to use.</li>
</ul>
<p>These ways to define the consistent hash key can be use together and at
the same time for one router. The <tt class="docutils literal"><span class="pre">withHashMapper</span></tt> is tried first.</p>
<p>Code example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.UntypedActor</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.routing.ConsistentHashingRouter.ConsistentHashable</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">Cache</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;();</span>

  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="n">instanceof</span> <span class="nc">Entry</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Entry</span> <span class="n">entry</span> <span class="k">=</span> <span class="o">(</span><span class="nc">Entry</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
      <span class="n">cache</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="n">key</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="n">instanceof</span> <span class="nc">Get</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Get</span> <span class="n">get</span> <span class="k">=</span> <span class="o">(</span><span class="nc">Get</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
      <span class="nc">Object</span> <span class="n">value</span> <span class="k">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">get</span><span class="o">.</span><span class="n">key</span><span class="o">);</span>
      <span class="n">getSender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nc">NOT_FOUND</span> <span class="k">:</span> <span class="kt">value</span><span class="o">,</span> 
        <span class="n">getContext</span><span class="o">().</span><span class="n">self</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="n">instanceof</span> <span class="nc">Evict</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Evict</span> <span class="n">evict</span> <span class="k">=</span> <span class="o">(</span><span class="nc">Evict</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
      <span class="n">cache</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="n">evict</span><span class="o">.</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">unhandled</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">public</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">Evict</span> <span class="n">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
  <span class="k">private</span> <span class="n">static</span> <span class="k">final</span> <span class="n">long</span> <span class="n">serialVersionUID</span> <span class="k">=</span> <span class="mi">1L</span><span class="o">;</span>
  <span class="n">public</span> <span class="k">final</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
  <span class="n">public</span> <span class="nc">Evict</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">key</span> <span class="k">=</span> <span class="n">key</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">public</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">Get</span> <span class="n">implements</span> <span class="nc">Serializable</span><span class="o">,</span> <span class="nc">ConsistentHashable</span> <span class="o">{</span>
  <span class="k">private</span> <span class="n">static</span> <span class="k">final</span> <span class="n">long</span> <span class="n">serialVersionUID</span> <span class="k">=</span> <span class="mi">1L</span><span class="o">;</span>
  <span class="n">public</span> <span class="k">final</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
  <span class="n">public</span> <span class="nc">Get</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">key</span> <span class="k">=</span> <span class="n">key</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="n">public</span> <span class="nc">Object</span> <span class="n">consistentHashKey</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
  <span class="o">}</span> 
<span class="o">}</span>

<span class="n">public</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">Entry</span> <span class="n">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
  <span class="k">private</span> <span class="n">static</span> <span class="k">final</span> <span class="n">long</span> <span class="n">serialVersionUID</span> <span class="k">=</span> <span class="mi">1L</span><span class="o">;</span>
  <span class="n">public</span> <span class="k">final</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
  <span class="n">public</span> <span class="k">final</span> <span class="nc">String</span> <span class="n">value</span><span class="o">;</span>
  <span class="n">public</span> <span class="nc">Entry</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">key</span> <span class="k">=</span> <span class="n">key</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">value</span> <span class="k">=</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">public</span> <span class="k">final</span> <span class="nc">String</span> <span class="nc">NOT_FOUND</span> <span class="k">=</span> <span class="s">&quot;NOT_FOUND&quot;</span><span class="o">;</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.Props</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.routing.ConsistentHashingRouter</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.routing.ConsistentHashingRouter.ConsistentHashMapper</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.routing.ConsistentHashingRouter.ConsistentHashableEnvelope</span><span class="o">;</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">ConsistentHashMapper</span> <span class="n">hashMapper</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ConsistentHashMapper</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">Object</span> <span class="n">hashKey</span><span class="o">(</span><span class="nc">Object</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="n">instanceof</span> <span class="nc">Evict</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">((</span><span class="nc">Evict</span><span class="o">)</span> <span class="n">message</span><span class="o">).</span><span class="n">key</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">};</span>

<span class="nc">ActorRef</span> <span class="n">cache</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">Cache</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span>
  <span class="k">new</span> <span class="nc">ConsistentHashingRouter</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="n">withHashMapper</span><span class="o">(</span><span class="n">hashMapper</span><span class="o">)),</span> 
  <span class="s">&quot;cache&quot;</span><span class="o">);</span>

<span class="n">cache</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConsistentHashableEnvelope</span><span class="o">(</span>
  <span class="k">new</span> <span class="nc">Entry</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="s">&quot;HELLO&quot;</span><span class="o">),</span> <span class="s">&quot;hello&quot;</span><span class="o">),</span> <span class="n">getRef</span><span class="o">());</span>
<span class="n">cache</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConsistentHashableEnvelope</span><span class="o">(</span>
  <span class="k">new</span> <span class="nc">Entry</span><span class="o">(</span><span class="s">&quot;hi&quot;</span><span class="o">,</span> <span class="s">&quot;HI&quot;</span><span class="o">),</span> <span class="s">&quot;hi&quot;</span><span class="o">),</span> <span class="n">getRef</span><span class="o">());</span>

<span class="n">cache</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Get</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">),</span> <span class="n">getRef</span><span class="o">());</span>
<span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;HELLO&quot;</span><span class="o">);</span>

<span class="n">cache</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Get</span><span class="o">(</span><span class="s">&quot;hi&quot;</span><span class="o">),</span> <span class="n">getRef</span><span class="o">());</span>
<span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;HI&quot;</span><span class="o">);</span>

<span class="n">cache</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Evict</span><span class="o">(</span><span class="s">&quot;hi&quot;</span><span class="o">),</span> <span class="n">getRef</span><span class="o">());</span>
<span class="n">cache</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Get</span><span class="o">(</span><span class="s">&quot;hi&quot;</span><span class="o">),</span> <span class="n">getRef</span><span class="o">());</span>
<span class="n">expectMsgEquals</span><span class="o">(</span><span class="nc">NOT_FOUND</span><span class="o">);</span>
</pre></div>
</div>
<p>In the above example you see that the <tt class="docutils literal"><span class="pre">Get</span></tt> message implements <tt class="docutils literal"><span class="pre">ConsistentHashable</span></tt> itself,
while the <tt class="docutils literal"><span class="pre">Entry</span></tt> message is wrapped in a <tt class="docutils literal"><span class="pre">ConsistentHashableEnvelope</span></tt>. The <tt class="docutils literal"><span class="pre">Evict</span></tt>
message is handled by the <tt class="docutils literal"><span class="pre">withHashMapper</span></tt>.</p>
<p>This is an example of how to define a consistent-hashing router in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">myrouter7</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">consistent</span><span class="o">-</span><span class="n">hashing</span>
    <span class="n">nr</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">instances</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="n">virtual</span><span class="o">-</span><span class="n">nodes</span><span class="o">-</span><span class="n">factor</span> <span class="k">=</span> <span class="mi">10</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="handling-for-special-messages">
<span id="router-special-messages-java"></span><h2>Handling for Special Messages</h2>
<p>Most messages sent to routers will be forwarded according to the routers' usual routing rules.
However there are a few types of messages that have special behavior.</p>
<div class="section" id="broadcast-messages">
<span id="broadcast-messages-java"></span><h3>Broadcast Messages</h3>
<p>A <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message can be used to send a message to <em>all</em> of a router's routees. When a router
receives a <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message, it will broadcast that message's <em>payload</em> to all routees, no
matter how that router would normally route its messages.</p>
<p>The example below shows how you would use a <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message to send a very important message
to every routee of a router.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">router</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="s">&quot;Watch out for Davy Jones&#39; locker&quot;</span><span class="o">),</span> <span class="n">getSelf</span><span class="o">());</span>
</pre></div>
</div>
<p>In this example the router receives the <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message, extracts its payload
(<tt class="docutils literal"><span class="pre">&quot;Watch&nbsp;out&nbsp;for&nbsp;Davy&nbsp;Jones'&nbsp;locker&quot;</span></tt>), and then sends the payload on to all of the router's
routees. It is up to each each routee actor to handle the received payload message.</p>
</div>
<div class="section" id="poisonpill-messages">
<h3>PoisonPill Messages</h3>
<p>A <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message has special handling for all actors, including for routers. When any actor
receives a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message, that actor will be stopped. See the <a class="reference internal" href="untyped-actors.html#poison-pill-java"><em>PoisonPill</em></a>
documentation for details.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">router</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">PoisonPill</span><span class="o">.</span><span class="n">getInstance</span><span class="o">(),</span> <span class="n">getSelf</span><span class="o">());</span>
</pre></div>
</div>
<p>For a router, which normally passes on messages to routees, it is important to realise that
<tt class="docutils literal"><span class="pre">PoisonPill</span></tt> messages are processed by the router only. <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> messages sent to a router
will <em>not</em> be sent on to routees.</p>
<p>However, a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message sent to a router may still affect its routees, because it will
stop the router and when the router stops it also stops its children. Stopping children is normal
actor behavior. The router will stop routees that it has created as children. Each child will
process its current message and then tstop. This may lead to some messages being unprocessed. See
the documentation on <a class="reference internal" href="untyped-actors.html#stopping-actors-java"><em>Stopping actors</em></a> for more information.</p>
<p>If you wish to stop a router and its routees, but you would like the routees to first process all
the messages currently in their mailboxes, then you should not send a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message to the
router. Instead you should wrap a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message inside a broadcast message so that each
routee will the <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message directly. Note that this will stop all routees, even if the
routees aren't children of the router, i.e. even routees programmatically provided to the router.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">router</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">PoisonPill</span><span class="o">.</span><span class="n">getInstance</span><span class="o">()),</span> <span class="n">getSelf</span><span class="o">());</span>
</pre></div>
</div>
<p>With the code shown above, each routee will receive a <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message. Each routee will
continue to process its messages as normal, eventually processing the <tt class="docutils literal"><span class="pre">PoisonPill</span></tt>. This will
cause the routee to stop. After all routees have stopped the router will itself be <a class="reference internal" href="routing.html#note-router-terminated-children-java"><em>stopped
automatically</em></a> unless it is a dynamic router, e.g. using
a resizer.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Brendan W McAdams' excellent blog post <a class="reference external" href="http://blog.evilmonkeylabs.com/2013/01/17/Distributing_Akka_Workloads_And_Shutting_Down_After/">Distributing Akka Workloads - And Shutting Down Afterwards</a>
discusses in more detail how <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> messages can be used to shut down routers and routees.</p>
</div>
</div>
<div class="section" id="kill-messages">
<h3>Kill Messages</h3>
<p><tt class="docutils literal"><span class="pre">Kill</span></tt> messages are another type of message that has special handling. See
<a class="reference internal" href="untyped-actors.html#killing-actors-java"><em>Killing an Actor</em></a> for general information about how actors handle <tt class="docutils literal"><span class="pre">Kill</span></tt> messages.</p>
<p>When a <tt class="docutils literal"><span class="pre">Kill</span></tt> message is sent to a router the router processes the message internally, and does
<em>not</em> send it on to its routees. The router will throw an <tt class="xref py py-class docutils literal"><span class="pre">ActorKilledException</span></tt> and fail. It
will then be either resumed, restarted or terminated, depending how it is supervised.</p>
<p>Routees that are children of the router will also be suspended, and will be affected by the
supervision directive that is applied to the router. Routees that are not the routers children, i.e.
those that were created externally to the router, will not be affected.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">router</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">Kill</span><span class="o">.</span><span class="n">getInstance</span><span class="o">(),</span> <span class="n">getSelf</span><span class="o">());</span>
</pre></div>
</div>
<p>As with the <tt class="docutils literal"><span class="pre">PoisonPill</span></tt> message, there is a distinction between killing a router, which
indirectly kills its children (who happen to be routees), and killing routees directly (some of whom
may not be children.) To kill routees directly the router should be sent a <tt class="docutils literal"><span class="pre">Kill</span></tt> message wrapped
in a <tt class="docutils literal"><span class="pre">Broadcast</span></tt> message.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">router</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="nc">Kill</span><span class="o">.</span><span class="n">getInstance</span><span class="o">()),</span> <span class="n">getSelf</span><span class="o">());</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dynamically-resizable-routers">
<span id="resizable-routers-java"></span><h2>Dynamically Resizable Routers</h2>
<p>All routers can be used with a fixed number of routees or with a resize strategy to adjust the number
of routees dynamically.</p>
<p>This is an example of how to create a resizable router that is defined in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">myrouter2</span> <span class="o">{</span>
    <span class="n">router</span> <span class="k">=</span> <span class="n">round</span><span class="o">-</span><span class="n">robin</span>
    <span class="n">resizer</span> <span class="o">{</span>
      <span class="n">lower</span><span class="o">-</span><span class="n">bound</span> <span class="k">=</span> <span class="mi">2</span>
      <span class="n">upper</span><span class="o">-</span><span class="n">bound</span> <span class="k">=</span> <span class="mi">15</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">router2</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FromConfig</span><span class="o">()),</span> <span class="s">&quot;myrouter2&quot;</span><span class="o">);</span>
</pre></div>
</div>
<p>Several more configuration options are available and described in <tt class="docutils literal"><span class="pre">akka.actor.deployment.default.resizer</span></tt>
section of the reference <a class="reference internal" href="../general/configuration.html#configuration"><em>Configuration</em></a>.</p>
<p>This is an example of how to programmatically create a resizable router:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">int</span> <span class="n">lowerBound</span> <span class="k">=</span> <span class="mi">2</span><span class="o">;</span>
<span class="n">int</span> <span class="n">upperBound</span> <span class="k">=</span> <span class="mi">15</span><span class="o">;</span>
<span class="nc">DefaultResizer</span> <span class="n">resizer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DefaultResizer</span><span class="o">(</span><span class="n">lowerBound</span><span class="o">,</span> <span class="n">upperBound</span><span class="o">);</span>
<span class="nc">ActorRef</span> <span class="n">router3</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">ExampleActor</span><span class="o">.</span><span class="n">class</span><span class="o">).</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="n">resizer</span><span class="o">)));</span>
</pre></div>
</div>
<p><em>It is also worth pointing out that if you define the ``router`` in the configuration file then this value
will be used instead of any programmatically sent parameters.</em></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Resizing is triggered by sending messages to the actor pool, but it is not
completed synchronously; instead a message is sent to the “head”
<tt class="xref py py-class docutils literal"><span class="pre">Router</span></tt> to perform the size change. Thus you cannot rely on resizing
to instantaneously create new workers when all others are busy, because the
message just sent will be queued to the mailbox of a busy actor. To remedy
this, configure the pool to use a balancing dispatcher, see <a class="reference internal" href="routing.html#configuring-dispatchers">Configuring
Dispatchers</a> for more information.</p>
</div>
</div>
<div class="section" id="how-routing-is-designed-within-akka">
<span id="router-design-java"></span><h2>How Routing is Designed within Akka</h2>
<p>On the surface routers look like normal actors, but they are actually implemented differently.
Routers are designed to be extremely efficient at receiving messages and passing them quickly on to
routees.</p>
<p>A normal actor can be used for routing messages, but an actor's single-threaded processing can
become a bottleneck. Routers can achieve much higher throughput with an optimization to the usual
message-processing pipeline that allows concurrent routing. This is achieved by embedding routers'
routing logic directly in their <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt> rather than in the router actor. Messages sent to
a router's <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt> can be immediately routed to the routee, bypassing the single-threaded
router actor entirely.</p>
<p>The cost to this is, of course, that the internals of routing code are more complicated than if
routers were implemented with normal actors. Fortunately all of this complexity is invisible to
consumers of the routing API. However, it is something to be aware of when implementing your own
routers.</p>
</div>
<div class="section" id="custom-router">
<span id="custom-router-java"></span><h2>Custom Router</h2>
<p>You can create your own router should you not find any of the ones provided by Akka sufficient for your needs.
In order to roll your own router you have to fulfill certain criteria which are explained in this section.</p>
<p>Before creating your own router you should consider whether a normal actor with router-like
behavior might do the job just as well as a full-blown router. As explained
<a class="reference internal" href="routing.html#router-design-java"><em>above</em></a>, the primary benefit of routers over normal actors is their
higher performance. But they are somewhat more complicated to write than normal actors. Therefore if
lower maximum throughput is acceptable in your application you may wish to stick with traditional
actors. This section, however, assumes that you wish to get maximum performance and so demonstrates
how you can create your own router.</p>
<p>The router created in this example is a simple vote counter. It will route the votes to specific vote counter actors.
In this case we only have two parties the Republicans and the Democrats. We would like a router that forwards all
democrat related messages to the Democrat actor and all republican related messages to the Republican actor.</p>
<p>We begin with defining the class:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">VoteCountRouter</span> <span class="k">extends</span> <span class="nc">CustomRouterConfig</span> <span class="o">{</span>
  
  <span class="nd">@Override</span> <span class="n">public</span> <span class="nc">String</span> <span class="n">routerDispatcher</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Dispatchers</span><span class="o">.</span><span class="nc">DefaultDispatcherId</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="nd">@Override</span> <span class="n">public</span> <span class="nc">SupervisorStrategy</span> <span class="n">supervisorStrategy</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="n">defaultStrategy</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="c1">// crRoute ...</span>

<span class="o">}</span>
</pre></div>
</div>
<p>The next step is to implement the <tt class="docutils literal"><span class="pre">createCustomRoute</span></tt> method in the class just defined:</p>
<div class="highlight-scala"><pre>@Override
public CustomRoute createCustomRoute(RouteeProvider routeeProvider) {
  final ActorRef democratActor =
    routeeProvider.context().actorOf(Props.create(DemocratActor.class), "d");
  final ActorRef republicanActor =
    routeeProvider.context().actorOf(Props.create(RepublicanActor.class), "r");
  List&lt;ActorRef&gt; routees =
    Arrays.asList(new ActorRef[] { democratActor, republicanActor });

  routeeProvider.registerRoutees(routees);

  return new CustomRoute() {
    @Override
    public scala.collection.immutable.Seq&lt;Destination&gt; destinationsFor(
        ActorRef sender, Object msg) {
      switch ((Message) msg) {
      case DemocratVote:
      case DemocratCountResult:
        return akka.japi.Util.immutableSingletonSeq(
          new Destination(sender, democratActor));
      case RepublicanVote:
      case RepublicanCountResult:
        return akka.japi.Util.immutableSingletonSeq(
          new Destination(sender, republicanActor));
      default:
        throw new IllegalArgumentException("Unknown message: " + msg);
      }
    }
  };
}
</pre>
</div>
<p>As you can see above we start off by creating the routees and put them in a collection.</p>
<p>Make sure that you don't miss to implement the line below as it is <em>really</em> important.
It registers the routees internally and failing to call this method will
cause a <tt class="docutils literal"><span class="pre">ActorInitializationException</span></tt> to be thrown when the router is used.
Therefore always make sure to do the following in your custom router:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">routeeProvider</span><span class="o">.</span><span class="n">registerRoutees</span><span class="o">(</span><span class="n">routees</span><span class="o">);</span>
</pre></div>
</div>
<p>The routing logic is where your magic sauce is applied. In our example it inspects the message types
and forwards to the correct routee based on this:</p>
<div class="highlight-scala"><pre>return new CustomRoute() {
  @Override
  public scala.collection.immutable.Seq&lt;Destination&gt; destinationsFor(
      ActorRef sender, Object msg) {
    switch ((Message) msg) {
    case DemocratVote:
    case DemocratCountResult:
      return akka.japi.Util.immutableSingletonSeq(
        new Destination(sender, democratActor));
    case RepublicanVote:
    case RepublicanCountResult:
      return akka.japi.Util.immutableSingletonSeq(
        new Destination(sender, republicanActor));
    default:
      throw new IllegalArgumentException("Unknown message: " + msg);
    }
  }
};
</pre>
</div>
<p>As you can see above what's returned in the <tt class="docutils literal"><span class="pre">CustomRoute</span></tt> function, which defines the mapping
from incoming sender/message to a <tt class="docutils literal"><span class="pre">List</span></tt> of <tt class="docutils literal"><span class="pre">Destination(sender,</span> <span class="pre">routee)</span></tt>.
The sender is what &quot;parent&quot; the routee should see - changing this could be useful if you for example want
another actor than the original sender to intermediate the result of the routee (if there is a result).
For more information about how to alter the original sender we refer to the source code of
<a class="reference external" href="https://github.com/akka/akka/blob/master/akka-actor/src/main/scala/akka/routing/Routing.scala#L375">ScatterGatherFirstCompletedRouter</a></p>
<p>All in all the custom router looks like this:</p>
<div class="highlight-scala"><pre>enum Message {
  DemocratVote, DemocratCountResult, RepublicanVote, RepublicanCountResult
}

public class DemocratActor extends UntypedActor {
  int counter = 0;

  public void onReceive(Object msg) {
    switch ((Message) msg) {
    case DemocratVote:
      counter++;
      break;
    case DemocratCountResult:
      getSender().tell(counter, getSelf());
      break;
    default:
      unhandled(msg);
    }
  }
}

public class RepublicanActor extends UntypedActor {
  int counter = 0;

  public void onReceive(Object msg) {
    switch ((Message) msg) {
    case RepublicanVote:
      counter++;
      break;
    case RepublicanCountResult:
      getSender().tell(counter, getSelf());
      break;
    default:
      unhandled(msg);
    }
  }
}

public class VoteCountRouter extends CustomRouterConfig {
  
  @Override public String routerDispatcher() {
    return Dispatchers.DefaultDispatcherId();
  }
  
  @Override public SupervisorStrategy supervisorStrategy() {
    return SupervisorStrategy.defaultStrategy();
  }

  @Override
  public CustomRoute createCustomRoute(RouteeProvider routeeProvider) {
    final ActorRef democratActor =
      routeeProvider.context().actorOf(Props.create(DemocratActor.class), "d");
    final ActorRef republicanActor =
      routeeProvider.context().actorOf(Props.create(RepublicanActor.class), "r");
    List&lt;ActorRef&gt; routees =
      Arrays.asList(new ActorRef[] { democratActor, republicanActor });

    routeeProvider.registerRoutees(routees);

    return new CustomRoute() {
      @Override
      public scala.collection.immutable.Seq&lt;Destination&gt; destinationsFor(
          ActorRef sender, Object msg) {
        switch ((Message) msg) {
        case DemocratVote:
        case DemocratCountResult:
          return akka.japi.Util.immutableSingletonSeq(
            new Destination(sender, democratActor));
        case RepublicanVote:
        case RepublicanCountResult:
          return akka.japi.Util.immutableSingletonSeq(
            new Destination(sender, republicanActor));
        default:
          throw new IllegalArgumentException("Unknown message: " + msg);
        }
      }
    };
  }

}

</pre>
</div>
<p>If you are interested in how to use the VoteCountRouter it looks like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nd">@Test</span>
<span class="n">public</span> <span class="n">void</span> <span class="n">countVotesAsIntendedNotAsInFlorida</span><span class="o">()</span> <span class="n">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="nc">ActorRef</span> <span class="n">routedActor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
    <span class="nc">Props</span><span class="o">.</span><span class="n">empty</span><span class="o">().</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">VoteCountRouter</span><span class="o">()));</span>
  <span class="n">routedActor</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">DemocratVote</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">routedActor</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">DemocratVote</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">routedActor</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">RepublicanVote</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">routedActor</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">DemocratVote</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">routedActor</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">RepublicanVote</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="nc">Timeout</span> <span class="n">timeout</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Timeout</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;seconds&quot;</span><span class="o">));</span>
  <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">democratsResult</span> <span class="k">=</span>
    <span class="n">ask</span><span class="o">(</span><span class="n">routedActor</span><span class="o">,</span> <span class="nc">DemocratCountResult</span><span class="o">,</span> <span class="n">timeout</span><span class="o">);</span>
  <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">republicansResult</span> <span class="k">=</span>
    <span class="n">ask</span><span class="o">(</span><span class="n">routedActor</span><span class="o">,</span> <span class="nc">RepublicanCountResult</span><span class="o">,</span> <span class="n">timeout</span><span class="o">);</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">democratsResult</span><span class="o">,</span> <span class="n">timeout</span><span class="o">.</span><span class="n">duration</span><span class="o">()));</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">republicansResult</span><span class="o">,</span> <span class="n">timeout</span><span class="o">.</span><span class="n">duration</span><span class="o">()));</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p>When creating a cutom router the resulting RoutedActorRef optimizes the
sending of the message so that it does NOT go through the router’s mailbox
unless the route returns an empty recipient set.</p>
<p class="last">This means that the <tt class="docutils literal"><span class="pre">route</span></tt> function defined in the <tt class="docutils literal"><span class="pre">RouterConfig</span></tt>
or the function returned from <tt class="docutils literal"><span class="pre">CreateCustomRoute</span></tt> in
<tt class="docutils literal"><span class="pre">CustomRouterConfig</span></tt> is evaluated concurrently without protection by
the RoutedActorRef: either provide a reentrant (i.e. pure) implementation
or do the locking yourself!</p>
</div>
<div class="section" id="configured-custom-router">
<h3>Configured Custom Router</h3>
<p>It is possible to define configuration properties for custom routers. In the <tt class="docutils literal"><span class="pre">router</span></tt> property of the deployment
configuration you define the fully qualified class name of the router class. The router class must extend
<tt class="docutils literal"><span class="pre">akka.routing.CustomRouterConfig</span></tt> and have constructor with one <tt class="docutils literal"><span class="pre">com.typesafe.config.Config</span></tt> parameter.
The deployment section of the configuration is passed to the constructor.</p>
</div>
<div class="section" id="custom-resizer">
<h3>Custom Resizer</h3>
<p>A router with dynamically resizable number of routees is implemented by providing a <tt class="docutils literal"><span class="pre">akka.routing.Resizer</span></tt>
in <tt class="docutils literal"><span class="pre">resizer</span></tt> method of the <tt class="docutils literal"><span class="pre">RouterConfig</span></tt>. See <tt class="docutils literal"><span class="pre">akka.routing.DefaultResizer</span></tt> for inspiration
of how to write your own resize strategy.</p>
</div>
</div>
<div class="section" id="configuring-dispatchers">
<h2>Configuring Dispatchers</h2>
<p>The dispatcher for created children of the router will be taken from
<tt class="xref py py-class docutils literal"><span class="pre">Props</span></tt> as described in <a class="reference internal" href="dispatchers.html#dispatchers-java"><em>Dispatchers</em></a>. For a dynamic pool it
makes sense to configure the <tt class="xref py py-class docutils literal"><span class="pre">BalancingDispatcher</span></tt> if the precise
routing is not so important (i.e. no consistent hashing or round-robin is
required); this enables newly created routees to pick up work immediately by
stealing it from their siblings.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you provide a collection of actors to route to, then they will still use the same dispatcher
that was configured for them in their <tt class="docutils literal"><span class="pre">Props</span></tt>, it is not possible to change an actors dispatcher
after it has been created.</p>
</div>
<p>The “head” router cannot always run on the same dispatcher, because it
does not process the same type of messages, hence this special actor does
not use the dispatcher configured in <tt class="xref py py-class docutils literal"><span class="pre">Props</span></tt>, but takes the
<tt class="docutils literal"><span class="pre">routerDispatcher</span></tt> from the <tt class="xref py py-class docutils literal"><span class="pre">RouterConfig</span></tt> instead, which defaults to
the actor system’s default dispatcher. All standard routers allow setting this
property in their constructor or factory method, custom routers have to
implement the method in a suitable way.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">router</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">MyActor</span><span class="o">.</span><span class="n">class</span><span class="o">)</span>
  <span class="c1">// “head” router will run on &quot;head&quot; dispatcher</span>
  <span class="o">.</span><span class="n">withRouter</span><span class="o">(</span><span class="k">new</span> <span class="nc">RoundRobinRouter</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">withDispatcher</span><span class="o">(</span><span class="s">&quot;head&quot;</span><span class="o">))</span>
  <span class="c1">// MyActor “workers” will run on &quot;workers&quot; dispatcher</span>
  <span class="o">.</span><span class="n">withDispatcher</span><span class="o">(</span><span class="s">&quot;workers&quot;</span><span class="o">));</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is not allowed to configure the <tt class="docutils literal"><span class="pre">routerDispatcher</span></tt> to be a
<tt class="xref py py-class docutils literal"><span class="pre">BalancingDispatcher</span></tt> since the messages meant for the special
router actor cannot be processed by any other actor.</p>
</div>
<p>At first glance there seems to be an overlap between the
<tt class="xref py py-class docutils literal"><span class="pre">BalancingDispatcher</span></tt> and Routers, but they complement each other.
The balancing dispatcher is in charge of running the actors while the routers
are in charge of deciding which message goes where. A router can also have
children that span multiple actor systems, even remote ones, but a dispatcher
lives inside a single actor system.</p>
<p>When using a <tt class="xref py py-class docutils literal"><span class="pre">RoundRobinRouter</span></tt> with a <tt class="xref py py-class docutils literal"><span class="pre">BalancingDispatcher</span></tt>
there are some configuration settings to take into account.</p>
<ul class="simple">
<li>There can only be <tt class="docutils literal"><span class="pre">nr-of-instances</span></tt> messages being processed at the same
time no matter how many threads are configured for the
<tt class="xref py py-class docutils literal"><span class="pre">BalancingDispatcher</span></tt>.</li>
<li>Having <tt class="docutils literal"><span class="pre">throughput</span></tt> set to a low number makes no sense since you will only
be handing off to another actor that processes the same <tt class="xref py py-class docutils literal"><span class="pre">MailBox</span></tt>
as yourself, which can be costly. Either the message just got into the
mailbox and you can receive it as well as anybody else, or everybody else
is busy and you are the only one available to receive the message.</li>
<li>Resizing the number of routees only introduce inertia, since resizing
is performed at specified intervals, but work stealing is instantaneous.</li>
</ul>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://akka.io/faq">FAQ</a></li>
      <li><a href="http://typesafe.com/stack/downloads/akka">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>      
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>      
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://typesafe.com/products/typesafe-subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@typesafe.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/watermark.png" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2013 <a href="http://typesafe.com/">Typesafe Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Oct 23, 2013
    </p>          
  </div>
</div>
<script src="http://www.google.com/jsapi" type="text/javascript"></script>
<script type="text/javascript">
    google.load('search', '1', {language : 'en', style : google.loader.themes.MINIMALIST});
    google.setOnLoadCallback(function() {
    var customSearchOptions = {};  var customSearchControl = new google.search.CustomSearchControl(
    '003065520604945464838:izzukx8-qba', customSearchOptions);
    customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);
    customSearchControl.draw('cse');
    var path = window.location.pathname.split('/').slice(0,4);
    if(window.location.hostname && path.length >= 4) {
    var site = "site:" + window.location.hostname + path.join('/').toString();
    customSearchControl.setSearchStartingCallback(this, function(c, s, q) { s.setQueryAddition(site); });
    }
    }, true);
</script>
<style type="text/css">
    .gsc-control-cse {
    font-family: Arial, sans-serif;
    border-color: rgb(242, 242, 235);
    background-color: rgb(242, 242, 235);
    }
    .gsc-control-cse .gsc-table-result {
      font-family: Arial, sans-serif;
      display: block;
    }
    input.gsc-input {
    border-color: #BBBBBB;
    }
    input.gsc-search-button {
    border-color: rgb(34, 57, 64);
    background-color: rgb(68, 114, 129);
    color: #FFFFFF;
    }
    .gsc-tabHeader.gsc-tabhInactive {
    border-color: #777777;
    background-color: #777777;
    }
    .gsc-tabHeader.gsc-tabhActive {
    border-color: #333333;
    background-color: #333333;
    }
    .gsc-tabsArea {
    border-color: #333333;
    }
    .gsc-webResult.gsc-result,
    .gsc-results .gsc-imageResult {
      border-color: #666666;
      background-color: #FFFFFF;
      padding: 0.5em 0.5em;
    }
    .gsc-webResult.gsc-result:hover,
    .gsc-imageResult:hover {
      border-color: #AAAAAA;
      background-color: #FFFFFF;
      padding: 0.5em 0.5em;
    }
    .gsc-webResult.gsc-result.gsc-promotion:hover {
    border-color: #AAAAAA;
    background-color: #FFFFFF;
    }
    .gs-webResult.gs-result a.gs-title:link,
    .gs-webResult.gs-result a.gs-title:link b,
    .gs-imageResult a.gs-title:link,
    .gs-imageResult a.gs-title:link b {
    color: #444444;
    }
    .gs-webResult.gs-result a.gs-title:visited,
    .gs-webResult.gs-result a.gs-title:visited b,
    .gs-imageResult a.gs-title:visited,
    .gs-imageResult a.gs-title:visited b {
    color: #444444;
    }
    .gs-webResult.gs-result a.gs-title:hover,
    .gs-webResult.gs-result a.gs-title:hover b,
    .gs-imageResult a.gs-title:hover,
    .gs-imageResult a.gs-title:hover b {
    color: #444444;
    }
    .gs-webResult.gs-result a.gs-title:active,
    .gs-webResult.gs-result a.gs-title:active b,
    .gs-imageResult a.gs-title:active,
    .gs-imageResult a.gs-title:active b {
    color: #777777;
    }
    .gsc-cursor-page {
    color: #444444;
    }
    a.gsc-trailing-more-results:link {
    color: #444444;
    }
    .gs-webResult .gs-snippet,
    .gs-imageResult .gs-snippet,
    .gs-fileFormatType {
    color: #333333;
    }
    .gs-webResult div.gs-visibleUrl,
    .gs-imageResult div.gs-visibleUrl {
    color: #000000;
    }
    .gs-webResult div.gs-visibleUrl-short {
    color: #000000;
    }
    .gs-webResult div.gs-visibleUrl-short {
    display: none;
    }
    .gs-webResult div.gs-visibleUrl-long {
    display: block;
    }
    .gs-promotion div.gs-visibleUrl-short {
    display: none;
    }
    .gs-promotion div.gs-visibleUrl-long {
    display: block;
    }
    .gsc-cursor-box {
    border-color: #FFFFFF;
    }
    .gsc-results .gsc-cursor-box .gsc-cursor-page {
    border-color: #777777;
    background-color: #FFFFFF;
    color: #444444;
    }
    .gsc-results .gsc-cursor-box .gsc-cursor-current-page {
    border-color: #333333;
    background-color: #333333;
    color: #444444;
    }
    .gsc-webResult.gsc-result.gsc-promotion {
    border-color: #CCCCCC;
    background-color: #E6E6E6;
    }
    .gsc-completion-title {
    color: #444444;
    }
    .gsc-completion-snippet {
    color: #333333;
    }
    .gs-promotion a.gs-title:link,
    .gs-promotion a.gs-title:link *,
    .gs-promotion .gs-snippet a:link {
    color: #0000CC;
    }
    .gs-promotion a.gs-title:visited,
    .gs-promotion a.gs-title:visited *,
    .gs-promotion .gs-snippet a:visited {
    color: #0000CC;
    }
    .gs-promotion a.gs-title:hover,
    .gs-promotion a.gs-title:hover *,
    .gs-promotion .gs-snippet a:hover {
    color: #444444;
    }
    .gs-promotion a.gs-title:active,
    .gs-promotion a.gs-title:active *,
    .gs-promotion .gs-snippet a:active {
    color: #00CC00;
    }
    .gs-promotion .gs-snippet,
    .gs-promotion .gs-title .gs-promotion-title-right,
    .gs-promotion .gs-title .gs-promotion-title-right *  {
    color: #333333;
    }
    .gs-promotion .gs-visibleUrl,
    .gs-promotion .gs-visibleUrl-short {
    color: #00CC00;
    }
</style>
<script type="text/javascript">
  $('#toc').toc();
</script>
  

  </body>
</html>