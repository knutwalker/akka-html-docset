

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Encoding and decoding binary data &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Exo:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Networking" href="index-network.html" />
    <link rel="next" title="Using TCP" href="io-tcp.html" />
    <link rel="prev" title="I/O" href="io.html" />

  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img src="../_static/logo-small.png" /></a>
        </div>    
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://akka.io/faq">FAQ</a></li>
          <li><a href="http://typesafe.com/stack/downloads/akka">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>           
          <li><a href="http://typesafe.com/products/typesafe-subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Encoding and decoding binary data</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">           
              <li>
                 <span class="divider">|</span> <a href="io-tcp.html">Using TCP</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../index.html">Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="io.html">I/O</a> <span class="divider">|</span>
              </li>
              <li>
                Version 2.2.3
              </li>
            </ul>
          </div>
        </div>
        <div class="row"><div class="span9">
            
  <div class="section" id="encoding-and-decoding-binary-data">
<span id="io-java-codec"></span><h1>Encoding and decoding binary data</h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The IO implementation is marked as <strong>“experimental”</strong> as of its introduction
in Akka 2.2.0. We will continue to improve this API based on our users’
feedback, which implies that while we try to keep incompatible changes to a
minimum the binary compatibility guarantee for maintenance releases does not
apply to the contents of the <cite>akka.io</cite> package.</p>
</div>
<p>Akka adopted and adapted the implementation of data processing pipelines found
in the <tt class="docutils literal"><span class="pre">spray-io</span></tt> module. The idea is that encoding and decoding often
go hand in hand and keeping the code pertaining to one protocol layer together
is deemed more important than writing down the complete read side—say—in the
iteratee style in one go; pipelines encourage packaging the stages in a form
which lends itself better to reuse in a protocol stack. Another reason for
choosing this abstraction is that it is at times necessary to change the
behavior of encoding and decoding within a stage based on a message stream’s
state, and pipeline stages allow communication between the read and write
halves quite naturally.</p>
<p>The actual byte-fiddling can be done within pipeline stages, for example using
the rich API of <tt class="xref py py-class docutils literal"><span class="pre">ByteIterator</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">ByteStringBuilder</span></tt> as shown
below. All these activities are synchronous transformations which benefit
greatly from CPU affinity to make good use of those data caches. Therefore the
design of the pipeline infrastructure is completely synchronous, every stage’s
handler code can only directly return the events and/or commands resulting from
an input, there are no callbacks. Exceptions thrown within a pipeline stage
will abort processing of the whole pipeline under the assumption that
recoverable error conditions will be signaled in-band to the next stage instead
of raising an exception.</p>
<p>An overall “logical” pipeline can span multiple execution contexts, for example
starting with the low-level protocol layers directly within an actor handling
the reads and writes to a TCP connection and then being passed to a number of
higher-level actors which do the costly application level processing. This is
supported by feeding the generated events into a sink which sends them to
another actor, and that other actor will then upon reception feed them into its
own pipeline.</p>
<div class="section" id="introducing-the-sample-protocol">
<h2>Introducing the Sample Protocol</h2>
<p>In the following the process of implementing a protocol stack using pipelines
is demonstrated on the following simple example:</p>
<div class="highlight-text"><div class="highlight"><pre>frameLen: Int
persons: Int
persons times {
  first: String
  last: String
}
points: Int
points times Double
</pre></div>
</div>
<p>mapping to the following data type:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">Message</span> <span class="o">{</span>
  
  <span class="n">static</span> <span class="n">public</span> <span class="k">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="k">private</span> <span class="k">final</span> <span class="nc">String</span> <span class="n">first</span><span class="o">;</span>
    <span class="k">private</span> <span class="k">final</span> <span class="nc">String</span> <span class="n">last</span><span class="o">;</span>

    <span class="n">public</span> <span class="nc">Person</span><span class="o">(</span><span class="nc">String</span> <span class="n">first</span><span class="o">,</span> <span class="nc">String</span> <span class="n">last</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="n">first</span> <span class="k">=</span> <span class="n">first</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="n">last</span> <span class="k">=</span> <span class="n">last</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">public</span> <span class="nc">String</span> <span class="n">getFirst</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">first</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">public</span> <span class="nc">String</span> <span class="n">getLast</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">last</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="k">private</span> <span class="k">final</span> <span class="nc">Person</span><span class="o">[]</span> <span class="n">persons</span><span class="o">;</span>
  <span class="k">private</span> <span class="k">final</span> <span class="n">double</span><span class="o">[]</span> <span class="n">happinessCurve</span><span class="o">;</span>

  <span class="n">public</span> <span class="nc">Message</span><span class="o">(</span><span class="nc">Person</span><span class="o">[]</span> <span class="n">persons</span><span class="o">,</span> <span class="n">double</span><span class="o">[]</span> <span class="n">happinessCurve</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">persons</span> <span class="k">=</span> <span class="n">persons</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">happinessCurve</span> <span class="k">=</span> <span class="n">happinessCurve</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="nc">Person</span><span class="o">[]</span> <span class="n">getPersons</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">persons</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="n">double</span><span class="o">[]</span> <span class="n">getHappinessCurve</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">happinessCurve</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We will split the handling of this protocol into two parts: the frame-length
encoding handles the buffering necessary on the read side and the actual
encoding of the frame contents is done in a separate stage.</p>
</div>
<div class="section" id="building-a-pipeline-stage">
<h2>Building a Pipeline Stage</h2>
<p>As a common example, which is also included in the <tt class="docutils literal"><span class="pre">akka-actor</span></tt> package, let
us look at a framing protocol which works by prepending a length field to each
message (the following is a simplified version for demonstration purposes, the
real implementation is more configurable and implemented in Scala).</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">java.nio.ByteOrder</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="k">import</span> <span class="nn">scala.util.Either</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.io.AbstractSymmetricPipePair</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.io.PipePairFactory</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.io.PipelineContext</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.io.SymmetricPipePair</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.io.SymmetricPipelineStage</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.util.ByteString</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.util.ByteStringBuilder</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">LengthFieldFrame</span> <span class="k">extends</span>
    <span class="nc">SymmetricPipelineStage</span><span class="o">&lt;</span><span class="nc">PipelineContext</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="k">final</span> <span class="n">int</span> <span class="n">maxSize</span><span class="o">;</span>

  <span class="n">public</span> <span class="nc">LengthFieldFrame</span><span class="o">(</span><span class="n">int</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">maxSize</span> <span class="k">=</span> <span class="n">maxSize</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">SymmetricPipePair</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="k">final</span> <span class="nc">PipelineContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">PipePairFactory</span>
        <span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AbstractSymmetricPipePair</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;()</span> <span class="o">{</span>

          <span class="k">final</span> <span class="nc">ByteOrder</span> <span class="n">byteOrder</span> <span class="k">=</span> <span class="nc">ByteOrder</span><span class="o">.</span><span class="nc">BIG_ENDIAN</span><span class="o">;</span>
          <span class="nc">ByteString</span> <span class="n">buffer</span> <span class="k">=</span> <span class="kc">null</span><span class="o">;</span>

          <span class="nd">@Override</span>
          <span class="n">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;&gt;</span> <span class="n">onCommand</span><span class="o">(</span>
              <span class="nc">ByteString</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">final</span> <span class="n">int</span> <span class="n">length</span> <span class="k">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">length</span><span class="o">()</span> <span class="o">+</span> <span class="mi">4</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;&gt;(</span><span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">final</span> <span class="nc">ByteStringBuilder</span> <span class="n">bb</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ByteStringBuilder</span><span class="o">();</span>
            <span class="n">bb</span><span class="o">.</span><span class="n">putInt</span><span class="o">(</span><span class="n">length</span><span class="o">,</span> <span class="n">byteOrder</span><span class="o">);</span>
            <span class="n">bb</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">singleCommand</span><span class="o">(</span><span class="n">bb</span><span class="o">.</span><span class="n">result</span><span class="o">());</span>
          <span class="o">}</span>

          <span class="nd">@Override</span>
          <span class="n">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;&gt;</span> <span class="n">onEvent</span><span class="o">(</span>
              <span class="nc">ByteString</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;&gt;</span> <span class="n">res</span> <span class="k">=</span>
                <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;&gt;();</span>
            <span class="nc">ByteString</span> <span class="n">current</span> <span class="k">=</span> <span class="n">buffer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">event</span> <span class="k">:</span> <span class="kt">buffer.concat</span><span class="o">(</span><span class="kt">event</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">current</span><span class="o">.</span><span class="n">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">buffer</span> <span class="k">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
              <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">current</span><span class="o">.</span><span class="n">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">buffer</span> <span class="k">=</span> <span class="n">current</span><span class="o">;</span>
                <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">final</span> <span class="n">int</span> <span class="n">length</span> <span class="k">=</span> <span class="n">current</span><span class="o">.</span><span class="n">iterator</span><span class="o">().</span><span class="n">getInt</span><span class="o">(</span><span class="n">byteOrder</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">maxSize</span><span class="o">)</span>
                  <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span>
                      <span class="s">&quot;received too large frame of size &quot;</span> <span class="o">+</span> <span class="n">length</span> <span class="o">+</span> <span class="s">&quot; (max = &quot;</span>
                          <span class="o">+</span> <span class="n">maxSize</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">current</span><span class="o">.</span><span class="n">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">buffer</span> <span class="k">=</span> <span class="n">current</span><span class="o">;</span>
                  <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="n">res</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">makeEvent</span><span class="o">(</span><span class="n">current</span><span class="o">.</span><span class="n">slice</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">length</span><span class="o">)));</span>
                  <span class="n">current</span> <span class="k">=</span> <span class="n">current</span><span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
                <span class="o">}</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>

        <span class="o">});</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>In the end a pipeline stage is nothing more than a set of three methods: one
transforming commands arriving from above, one transforming events arriving
from below and the third transforming incoming management commands (not shown
here, see below for more information). The result of the transformation can in
either case be a sequence of commands flowing downwards or events flowing
upwards (or a combination thereof).</p>
<p>In the case above the data type for commands and events are equal as both
functions operate only on <tt class="docutils literal"><span class="pre">ByteString</span></tt>, and the transformation does not
change that type because it only adds or removes four octets at the front.</p>
<p>The pair of command and event transformation functions is represented by an
object of type <tt class="xref py py-class docutils literal"><span class="pre">AbstractPipePair</span></tt>, or in this case a
<tt class="xref py py-class docutils literal"><span class="pre">AbstractSymmetricPipePair</span></tt>.  This object could benefit from knowledge
about the context it is running in, for example an <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt>, and this
context is introduced by making a <tt class="xref py py-class docutils literal"><span class="pre">PipelineStage</span></tt> be a factory for
producing a <tt class="xref py py-class docutils literal"><span class="pre">PipePair</span></tt>. The factory method is called <tt class="xref py py-meth docutils literal"><span class="pre">apply</span></tt> (a
Scala tradition) and receives the context object as its argument. The
implementation of this factory method could now make use of the context in
whatever way it sees fit, you will see an example further down.</p>
</div>
<div class="section" id="manipulating-bytestrings">
<h2>Manipulating ByteStrings</h2>
<p>The second stage of our sample protocol stack illustrates in more depth what
showed only a little in the pipeline stage built above: constructing and
deconstructing byte strings. Let us first take a look at the encoder:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">MessageStage</span> <span class="k">extends</span>
    <span class="nc">SymmetricPipelineStage</span><span class="o">&lt;</span><span class="nc">HasByteOrder</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">SymmetricPipePair</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="k">final</span> <span class="nc">HasByteOrder</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">return</span> <span class="nc">PipePairFactory</span>
        <span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AbstractSymmetricPipePair</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;()</span> <span class="o">{</span>

          <span class="k">final</span> <span class="nc">ByteOrder</span> <span class="n">byteOrder</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">byteOrder</span><span class="o">();</span>

          <span class="k">private</span> <span class="n">void</span> <span class="n">putString</span><span class="o">(</span><span class="nc">ByteStringBuilder</span> <span class="n">builder</span><span class="o">,</span> <span class="nc">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">final</span> <span class="n">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="k">=</span> <span class="nc">ByteString</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">).</span><span class="n">toArray</span><span class="o">();</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">putInt</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">length</span><span class="o">,</span> <span class="n">byteOrder</span><span class="o">);</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">putBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
          <span class="o">}</span>

          <span class="nd">@Override</span>
          <span class="n">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;&gt;</span> <span class="n">onCommand</span><span class="o">(</span><span class="nc">Message</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">final</span> <span class="nc">ByteStringBuilder</span> <span class="n">builder</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ByteStringBuilder</span><span class="o">();</span>

            <span class="n">builder</span><span class="o">.</span><span class="n">putInt</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">getPersons</span><span class="o">().</span><span class="n">length</span><span class="o">,</span> <span class="n">byteOrder</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Message</span><span class="o">.</span><span class="nc">Person</span> <span class="n">p</span> <span class="k">:</span> <span class="kt">cmd.getPersons</span><span class="o">())</span> <span class="o">{</span>
              <span class="n">putString</span><span class="o">(</span><span class="n">builder</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="n">getFirst</span><span class="o">());</span>
              <span class="n">putString</span><span class="o">(</span><span class="n">builder</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="n">getLast</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="n">builder</span><span class="o">.</span><span class="n">putInt</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">getHappinessCurve</span><span class="o">().</span><span class="n">length</span><span class="o">,</span> <span class="n">byteOrder</span><span class="o">);</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">putDoubles</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">getHappinessCurve</span><span class="o">(),</span> <span class="n">byteOrder</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">singleCommand</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="n">result</span><span class="o">());</span>
          <span class="o">}</span>

          <span class="c1">// decoding omitted ...</span>

        <span class="o">});</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Note how the byte order to be used by this stage is fixed in exactly one place,
making it impossible get wrong between commands and events; the way how the
byte order is passed into the stage demonstrates one possible use for the
stage’s <tt class="docutils literal"><span class="pre">context</span></tt> parameter.</p>
<p>The basic tool for constucting a <tt class="xref py py-class docutils literal"><span class="pre">ByteString</span></tt> is a
<tt class="xref py py-class docutils literal"><span class="pre">ByteStringBuilder</span></tt>. This builder is specialized for concatenating byte
representations of the primitive data types like <tt class="docutils literal"><span class="pre">Int</span></tt> and <tt class="docutils literal"><span class="pre">Double</span></tt> or
arrays thereof.  Encoding a <tt class="docutils literal"><span class="pre">String</span></tt> requires a bit more work because not
only the sequence of bytes needs to be encoded but also the length, otherwise
the decoding stage would not know where the <tt class="docutils literal"><span class="pre">String</span></tt> terminates. When all
values making up the <tt class="xref py py-class docutils literal"><span class="pre">Message</span></tt> have been appended to the builder, we
simply pass the resulting <tt class="xref py py-class docutils literal"><span class="pre">ByteString</span></tt> on to the next stage as a command
using the optimized <tt class="xref py py-meth docutils literal"><span class="pre">singleCommand</span></tt> facility.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The <tt class="xref py py-meth docutils literal"><span class="pre">singleCommand</span></tt> and <tt class="xref py py-meth docutils literal"><span class="pre">singleEvent</span></tt> methods provide a way to
generate responses which transfer exactly one result from one pipeline stage
to the next without suffering the overhead of object allocations. This means
that the returned collection object will not work for anything else (you will
get <tt class="xref py py-class docutils literal"><span class="pre">ClassCastExceptions</span></tt>!) and this facility can only be used <em>EXACTLY
ONCE</em> during the processing of one input (command or event).</p>
</div>
<p>Now let us look at the decoder side:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">private</span> <span class="nc">String</span> <span class="n">getString</span><span class="o">(</span><span class="nc">ByteIterator</span> <span class="n">iter</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">final</span> <span class="n">int</span> <span class="n">length</span> <span class="k">=</span> <span class="n">iter</span><span class="o">.</span><span class="n">getInt</span><span class="o">(</span><span class="n">byteOrder</span><span class="o">);</span>
  <span class="k">final</span> <span class="n">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="k">=</span> <span class="k">new</span> <span class="n">byte</span><span class="o">[</span><span class="kt">length</span><span class="o">];</span>
  <span class="n">iter</span><span class="o">.</span><span class="n">getBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
  <span class="k">return</span> <span class="nc">ByteString</span><span class="o">.</span><span class="n">fromArray</span><span class="o">(</span><span class="n">bytes</span><span class="o">).</span><span class="n">utf8String</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="n">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;&gt;</span> <span class="n">onEvent</span><span class="o">(</span><span class="nc">ByteString</span> <span class="n">evt</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">final</span> <span class="nc">ByteIterator</span> <span class="n">iter</span> <span class="k">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">iterator</span><span class="o">();</span>

  <span class="k">final</span> <span class="n">int</span> <span class="n">personLength</span> <span class="k">=</span> <span class="n">iter</span><span class="o">.</span><span class="n">getInt</span><span class="o">(</span><span class="n">byteOrder</span><span class="o">);</span>
  <span class="k">final</span> <span class="nc">Message</span><span class="o">.</span><span class="nc">Person</span><span class="o">[]</span> <span class="n">persons</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">.</span><span class="nc">Person</span><span class="o">[</span><span class="kt">personLength</span><span class="o">];</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">int</span> <span class="n">i</span> <span class="k">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">personLength</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">persons</span><span class="o">[</span><span class="kt">i</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">.</span><span class="nc">Person</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">iter</span><span class="o">),</span> <span class="n">getString</span><span class="o">(</span><span class="n">iter</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="k">final</span> <span class="n">int</span> <span class="n">curveLength</span> <span class="k">=</span> <span class="n">iter</span><span class="o">.</span><span class="n">getInt</span><span class="o">(</span><span class="n">byteOrder</span><span class="o">);</span>
  <span class="k">final</span> <span class="n">double</span><span class="o">[]</span> <span class="n">curve</span> <span class="k">=</span> <span class="k">new</span> <span class="n">double</span><span class="o">[</span><span class="kt">curveLength</span><span class="o">];</span>
  <span class="n">iter</span><span class="o">.</span><span class="n">getDoubles</span><span class="o">(</span><span class="n">curve</span><span class="o">,</span> <span class="n">byteOrder</span><span class="o">);</span>

  <span class="c1">// verify that this was all; could be left out to allow future</span>
  <span class="c1">// extensions</span>
  <span class="n">assert</span> <span class="n">iter</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">();</span>

  <span class="k">return</span> <span class="n">singleEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">Message</span><span class="o">(</span><span class="n">persons</span><span class="o">,</span> <span class="n">curve</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The decoding side does the same things that the encoder does in the same order,
it just uses a <tt class="xref py py-class docutils literal"><span class="pre">ByteIterator</span></tt> to retrieve primitive data types or arrays
of those from the underlying <tt class="xref py py-class docutils literal"><span class="pre">ByteString</span></tt>. And in the end it hands the
assembled <tt class="xref py py-class docutils literal"><span class="pre">Message</span></tt> as an event to the next stage using the optimized
<tt class="xref py py-meth docutils literal"><span class="pre">singleEvent</span></tt> facility (see warning above).</p>
</div>
<div class="section" id="building-a-pipeline">
<h2>Building a Pipeline</h2>
<p>Given the two pipeline stages introduced in the sections above we can now put
them to some use. First we define some message to be encoded:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">Message</span> <span class="n">msg</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">(</span>
    <span class="k">new</span> <span class="nc">Message</span><span class="o">.</span><span class="nc">Person</span><span class="o">[]</span> <span class="o">{</span> 
        <span class="k">new</span> <span class="nc">Message</span><span class="o">.</span><span class="nc">Person</span><span class="o">(</span><span class="s">&quot;Alice&quot;</span><span class="o">,</span> <span class="s">&quot;Gibbons&quot;</span><span class="o">),</span>
        <span class="k">new</span> <span class="nc">Message</span><span class="o">.</span><span class="nc">Person</span><span class="o">(</span><span class="s">&quot;Bob&quot;</span><span class="o">,</span> <span class="s">&quot;Sparseley&quot;</span><span class="o">)</span>
    <span class="o">},</span>
    <span class="k">new</span> <span class="n">double</span><span class="o">[]</span> <span class="o">{</span> <span class="mf">1.0</span><span class="o">,</span> <span class="mf">3.0</span><span class="o">,</span> <span class="mf">5.0</span> <span class="o">});</span>
</pre></div>
</div>
<p>Then we need to create a pipeline context which satisfies our declared needs:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Context</span> <span class="k">extends</span> <span class="nc">AbstractPipelineContext</span> <span class="n">implements</span> <span class="nc">HasByteOrder</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">ByteOrder</span> <span class="n">byteOrder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">java</span><span class="o">.</span><span class="n">nio</span><span class="o">.</span><span class="nc">ByteOrder</span><span class="o">.</span><span class="nc">BIG_ENDIAN</span><span class="o">;</span>
  <span class="o">}</span>
  
<span class="o">}</span>
<span class="k">final</span> <span class="nc">Context</span> <span class="n">ctx</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Context</span><span class="o">();</span>
</pre></div>
</div>
<p>Building the pipeline and encoding this message then is quite simple:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">PipelineStage</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="n">stages</span> <span class="k">=</span>
    <span class="nc">PipelineStage</span><span class="o">.</span><span class="n">sequence</span><span class="o">(</span>
        <span class="k">new</span> <span class="nc">MessageStage</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nc">LengthFieldFrame</span><span class="o">(</span><span class="mi">10000</span><span class="o">)</span>
    <span class="o">);</span>

<span class="k">final</span> <span class="nc">PipelineSink</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">Message</span><span class="o">&gt;</span> <span class="n">sink</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">PipelineSink</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">Message</span><span class="o">&gt;()</span> <span class="o">{</span>

      <span class="nd">@Override</span>
      <span class="n">public</span> <span class="n">void</span> <span class="n">onCommand</span><span class="o">(</span><span class="nc">ByteString</span> <span class="n">cmd</span><span class="o">)</span> <span class="n">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="n">commandHandler</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">cmd</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="n">public</span> <span class="n">void</span> <span class="n">onEvent</span><span class="o">(</span><span class="nc">Message</span> <span class="n">evt</span><span class="o">)</span> <span class="n">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="n">eventHandler</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">evt</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">};</span>
    
<span class="k">final</span> <span class="nc">PipelineInjector</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="n">injector</span> <span class="k">=</span>
    <span class="nc">PipelineFactory</span><span class="o">.</span><span class="n">buildWithSink</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">stages</span><span class="o">,</span> <span class="n">sink</span><span class="o">);</span>

<span class="n">injector</span><span class="o">.</span><span class="n">injectCommand</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
</pre></div>
</div>
<p>First we <em>sequence</em> the two stages, i.e. attach them such that the output of
one becomes the input of the other. Then we create a <tt class="xref py py-class docutils literal"><span class="pre">PipelineSink</span></tt>
which is essentially a callback interface for what shall happen with the
encoded commands or decoded events, respectively. Then we build the pipeline
using the <tt class="xref py py-class docutils literal"><span class="pre">PipelineFactory</span></tt>, which returns an interface for feeding
commands and events into this pipeline instance. As a demonstration of how to
use this, we simply encode the message shown above and the resulting
<tt class="xref py py-class docutils literal"><span class="pre">ByteString</span></tt> will then be sent to the <tt class="docutils literal"><span class="pre">commandHandler</span></tt> actor. Decoding
works in the same way, only using <tt class="xref py py-meth docutils literal"><span class="pre">injectEvent</span></tt>.</p>
<p>Injecting into a pipeline using a <tt class="xref py py-class docutils literal"><span class="pre">PipelineInjector</span></tt> will catch
exceptions resulting from processing the input, in which case the exception
(there can only be one per injection) is passed into the respective sink. The
default implementation of <tt class="xref py py-meth docutils literal"><span class="pre">onCommandFailure</span></tt> and <tt class="xref py py-meth docutils literal"><span class="pre">onEventFailure</span></tt>
will re-throw the exception (whence originates the <tt class="docutils literal"><span class="pre">throws</span></tt> declaration of
the <tt class="docutils literal"><span class="pre">inject*</span></tt> method).</p>
</div>
<div class="section" id="using-the-pipelines-context">
<h2>Using the Pipeline’s Context</h2>
<p>Up to this point there was always a parameter <tt class="docutils literal"><span class="pre">ctx</span></tt> which was used when
constructing a pipeline, but it was not explained in full. The context is a
piece of information which is made available to all stages of a pipeline. The
context may also carry behavior, provide infrastructure or helper methods etc.
It should be noted that the context is bound to the pipeline and as such must
not be accessed concurrently from different threads unless care is taken to
properly synchronize such access. Since the context will in many cases be
provided by an actor it is not recommended to share this context with code
executing outside of the actor’s message handling.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">A PipelineContext instance <em>MUST NOT</em> be used by two different pipelines
since it contains mutable fields which are used during message processing.</p>
</div>
</div>
<div class="section" id="using-management-commands">
<h2>Using Management Commands</h2>
<p>Since pipeline stages do not have any reference to the pipeline or even to
their neighbors they cannot directly effect the injection of commands or events
outside of their normal processing. But sometimes things need to happen driven
by a timer, for example. In this case the timer would need to cause sending
tick messages to the whole pipeline, and those stages which wanted to receive
them would act upon those. In order to keep the type signatures for events and
commands useful, such external triggers are sent out-of-band, via a different
channel—the management port. One example which makes use of this facility is
the <tt class="xref py py-class docutils literal"><span class="pre">TickGenerator</span></tt> which comes included with <tt class="docutils literal"><span class="pre">akka-actor</span></tt> (this is a
transcription of the Scala version which is actually included in the
<tt class="docutils literal"><span class="pre">akka-actor</span></tt> JAR):</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="n">interface</span> <span class="nc">HasActorContext</span> <span class="k">extends</span> <span class="nc">PipelineContext</span> <span class="o">{</span>
  
  <span class="n">public</span> <span class="nc">ActorContext</span> <span class="n">getContext</span><span class="o">();</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">TickGenerator</span><span class="o">&lt;</span><span class="nc">Cmd</span><span class="o">,</span> <span class="nc">Evt</span><span class="o">&gt;</span> <span class="k">extends</span>
    <span class="nc">PipelineStage</span><span class="o">&lt;</span><span class="nc">HasActorContext</span><span class="o">,</span> <span class="nc">Cmd</span><span class="o">,</span> <span class="nc">Cmd</span><span class="o">,</span> <span class="nc">Evt</span><span class="o">,</span> <span class="nc">Evt</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="n">public</span> <span class="n">static</span> <span class="n">interface</span> <span class="nc">Trigger</span> <span class="o">{};</span>
  
  <span class="n">public</span> <span class="n">static</span> <span class="k">class</span> <span class="nc">Tick</span> <span class="n">implements</span> <span class="nc">Trigger</span> <span class="o">{</span>
    <span class="k">final</span> <span class="nc">FiniteDuration</span> <span class="n">timestamp</span><span class="o">;</span>

    <span class="n">public</span> <span class="nc">Tick</span><span class="o">(</span><span class="nc">FiniteDuration</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">super</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="n">timestamp</span> <span class="k">=</span> <span class="n">timestamp</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">public</span> <span class="nc">FiniteDuration</span> <span class="n">getTimestamp</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">timestamp</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">final</span> <span class="nc">FiniteDuration</span> <span class="n">interval</span><span class="o">;</span>

  <span class="n">public</span> <span class="nc">TickGenerator</span><span class="o">(</span><span class="nc">FiniteDuration</span> <span class="n">interval</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">interval</span> <span class="k">=</span> <span class="n">interval</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">PipePair</span><span class="o">&lt;</span><span class="nc">Cmd</span><span class="o">,</span> <span class="nc">Cmd</span><span class="o">,</span> <span class="nc">Evt</span><span class="o">,</span> <span class="nc">Evt</span><span class="o">&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="k">final</span> <span class="nc">HasActorContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">PipePairFactory</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span>
        <span class="k">new</span> <span class="nc">AbstractPipePair</span><span class="o">&lt;</span><span class="nc">Cmd</span><span class="o">,</span> <span class="nc">Cmd</span><span class="o">,</span> <span class="nc">Evt</span><span class="o">,</span> <span class="nc">Evt</span><span class="o">&gt;()</span> <span class="o">{</span>
      
          <span class="k">private</span> <span class="k">final</span> <span class="nc">Trigger</span> <span class="n">trigger</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Trigger</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">public</span> <span class="nc">String</span> <span class="n">toString</span><span class="o">()</span> <span class="o">{</span>
              <span class="k">return</span> <span class="s">&quot;Tick[&quot;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getContext</span><span class="o">().</span><span class="n">self</span><span class="o">().</span><span class="n">path</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">};</span>
          
          <span class="k">private</span> <span class="n">void</span> <span class="n">schedule</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">final</span> <span class="nc">ActorSystem</span> <span class="n">system</span> <span class="k">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">();</span>
            <span class="n">system</span><span class="o">.</span><span class="n">scheduler</span><span class="o">().</span><span class="n">scheduleOnce</span><span class="o">(</span><span class="n">interval</span><span class="o">,</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">getContext</span><span class="o">().</span><span class="n">self</span><span class="o">(),</span> <span class="n">trigger</span><span class="o">,</span> <span class="n">system</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
          <span class="o">}</span>

          <span class="o">{</span>
            <span class="n">schedule</span><span class="o">();</span>
          <span class="o">}</span>

          <span class="nd">@Override</span>
          <span class="n">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">Evt</span><span class="o">,</span> <span class="nc">Cmd</span><span class="o">&gt;&gt;</span> <span class="n">onCommand</span><span class="o">(</span><span class="nc">Cmd</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">singleCommand</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
          <span class="o">}</span>

          <span class="nd">@Override</span>
          <span class="n">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">Evt</span><span class="o">,</span> <span class="nc">Cmd</span><span class="o">&gt;&gt;</span> <span class="n">onEvent</span><span class="o">(</span><span class="nc">Evt</span> <span class="n">evt</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">singleEvent</span><span class="o">(</span><span class="n">evt</span><span class="o">);</span>
          <span class="o">}</span>

          <span class="nd">@Override</span>
          <span class="n">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">Evt</span><span class="o">,</span> <span class="nc">Cmd</span><span class="o">&gt;&gt;</span> <span class="n">onManagementCommand</span><span class="o">(</span><span class="nc">Object</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">trigger</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">ctx</span><span class="o">.</span><span class="n">getContext</span><span class="o">().</span><span class="n">self</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Tick</span><span class="o">(</span><span class="nc">Deadline</span><span class="o">.</span><span class="n">now</span><span class="o">().</span><span class="n">time</span><span class="o">()),</span>
                  <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
              <span class="n">schedule</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="n">emptyList</span><span class="o">();</span>
          <span class="o">}</span>

        <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>This pipeline stage is to be used within an actor, and it will make use of this
context in order to schedule the delivery of <tt class="docutils literal"><span class="pre">Tick</span></tt> messages; the actor is
then supposed to feed these messages into the management port of the pipeline.
An example could look like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">Processor</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">class</span> <span class="nc">Context</span> <span class="k">extends</span> <span class="nc">AbstractPipelineContext</span> 
      <span class="n">implements</span> <span class="nc">HasByteOrder</span><span class="o">,</span> <span class="nc">HasActorContext</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="nc">ActorContext</span> <span class="n">getContext</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">Processor</span><span class="o">.</span><span class="k">this</span><span class="o">.</span><span class="n">getContext</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="nc">ByteOrder</span> <span class="n">byteOrder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">java</span><span class="o">.</span><span class="n">nio</span><span class="o">.</span><span class="nc">ByteOrder</span><span class="o">.</span><span class="nc">BIG_ENDIAN</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="k">final</span> <span class="nc">Context</span> <span class="n">ctx</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Context</span><span class="o">();</span>

  <span class="k">final</span> <span class="nc">FiniteDuration</span> <span class="n">interval</span> <span class="k">=</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">SECONDS</span><span class="o">);</span>

  <span class="k">final</span> <span class="nc">PipelineStage</span><span class="o">&lt;</span><span class="nc">Context</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="n">stages</span> <span class="k">=</span>
    <span class="nc">PipelineStage</span><span class="o">.</span><span class="n">sequence</span><span class="o">(</span>
        <span class="c1">// Java 7 can infer these types, Java 6 cannot</span>
    <span class="nc">PipelineStage</span><span class="o">.&lt;</span><span class="nc">Context</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> <span class="nc">Message</span><span class="o">,</span> 
        <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="n">sequence</span><span class="o">(</span> <span class="c1">//</span>
      <span class="k">new</span> <span class="nc">TickGenerator</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">Message</span><span class="o">&gt;(</span><span class="n">interval</span><span class="o">),</span> <span class="c1">//</span>
      <span class="k">new</span> <span class="nc">MessageStage</span><span class="o">()),</span> <span class="c1">//</span>
      <span class="k">new</span> <span class="nc">LengthFieldFrame</span><span class="o">(</span><span class="mi">10000</span><span class="o">));</span>

  <span class="k">private</span> <span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">evts</span><span class="o">;</span>
  <span class="k">private</span> <span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">cmds</span><span class="o">;</span>

  <span class="k">final</span> <span class="nc">PipelineInjector</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;</span> <span class="n">injector</span> <span class="k">=</span> <span class="nc">PipelineFactory</span>
      <span class="o">.</span><span class="n">buildWithSink</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">stages</span><span class="o">,</span> <span class="k">new</span> <span class="nc">PipelineSink</span><span class="o">&lt;</span><span class="nc">ByteString</span><span class="o">,</span> <span class="nc">Message</span><span class="o">&gt;()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">onCommand</span><span class="o">(</span><span class="nc">ByteString</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">cmds</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">cmd</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">onEvent</span><span class="o">(</span><span class="nc">Message</span> <span class="n">evt</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">evts</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">evt</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
        <span class="o">}</span>
      <span class="o">});</span>

  <span class="n">public</span> <span class="nc">Processor</span><span class="o">(</span><span class="nc">ActorRef</span> <span class="n">cmds</span><span class="o">,</span> <span class="nc">ActorRef</span> <span class="n">evts</span><span class="o">)</span> <span class="n">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">cmds</span> <span class="k">=</span> <span class="n">cmds</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">evts</span> <span class="k">=</span> <span class="n">evts</span><span class="o">;</span>
  <span class="o">}</span>
  
  <span class="c1">// omitted ...</span>
  
  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="n">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="n">instanceof</span> <span class="nc">Message</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">injector</span><span class="o">.</span><span class="n">injectCommand</span><span class="o">((</span><span class="nc">Message</span><span class="o">)</span> <span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="n">instanceof</span> <span class="nc">ByteString</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">injector</span><span class="o">.</span><span class="n">injectEvent</span><span class="o">((</span><span class="nc">ByteString</span><span class="o">)</span> <span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="n">instanceof</span> <span class="nc">TickGenerator</span><span class="o">.</span><span class="nc">Trigger</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">injector</span><span class="o">.</span><span class="n">managementCommand</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>This actor extends our well-known pipeline with the tick generator and attaches
the outputs to functions which send commands and events to actors for further
processing. The pipeline stages will then all receive on <tt class="docutils literal"><span class="pre">Tick</span></tt> per second
which can be used like so:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">private</span> <span class="nc">FiniteDuration</span> <span class="n">lastTick</span> <span class="k">=</span> <span class="nc">Duration</span><span class="o">.</span><span class="nc">Zero</span><span class="o">();</span>

<span class="nd">@Override</span>
<span class="n">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Either</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">ByteString</span><span class="o">&gt;&gt;</span> <span class="n">onManagementCommand</span><span class="o">(</span><span class="nc">Object</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// omitted ...</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">cmd</span> <span class="n">instanceof</span> <span class="nc">TickGenerator</span><span class="o">.</span><span class="nc">Tick</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">final</span> <span class="nc">FiniteDuration</span> <span class="n">timestamp</span> <span class="k">=</span> <span class="o">((</span><span class="nc">TickGenerator</span><span class="o">.</span><span class="nc">Tick</span><span class="o">)</span> <span class="n">cmd</span><span class="o">)</span>
        <span class="o">.</span><span class="n">getTimestamp</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="s">&quot;time since last tick: &quot;</span>
        <span class="o">+</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">minus</span><span class="o">(</span><span class="n">lastTick</span><span class="o">));</span>
    <span class="n">lastTick</span> <span class="k">=</span> <span class="n">timestamp</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="n">emptyList</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Management commands are delivered to all stages of a pipeline “effectively
parallel”, like on a broadcast medium. No code will actually run concurrently
since a pipeline is strictly single-threaded, but the order in which these
commands are processed is not specified.</p>
</div>
<p>The intended purpose of management commands is for each stage to define its
special command types and then listen only to those (where the aforementioned
<tt class="docutils literal"><span class="pre">Tick</span></tt> message is a useful counter-example), exactly like sending packets on
a wifi network where every station receives all traffic but reacts only to
those messages which are destined for it.</p>
<p>If you need all stages to react upon something in their defined order, then
this must be modeled either as a command or event, i.e. it will be part of the
“business” type of the pipeline.</p>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://akka.io/faq">FAQ</a></li>
      <li><a href="http://typesafe.com/stack/downloads/akka">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>      
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>      
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://typesafe.com/products/typesafe-subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@typesafe.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/watermark.png" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2013 <a href="http://typesafe.com/">Typesafe Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Feb 22, 2014
    </p>          
  </div>
</div>
<script type="text/javascript">
  $('#toc').toc();
</script>
  

  </body>
</html>