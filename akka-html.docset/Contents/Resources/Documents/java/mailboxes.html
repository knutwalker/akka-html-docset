


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Mailboxes &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Exo:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Actors" href="index-actors.html" />
    <link rel="next" title="Routing" href="routing.html" />
    <link rel="prev" title="Dispatchers" href="dispatchers.html" />
    <!--Google Analytics-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-21117439-1']);
      _gaq.push(['_setDomainName', 'akka.io']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })()
    </script>

  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img src="../_static/logo-small.png" /></a>
        </div>    
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://akka.io/faq">FAQ</a></li>
          <li><a href="http://typesafe.com/stack/downloads/akka">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>           
          <li><a href="http://typesafe.com/products/typesafe-subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Mailboxes</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">           
              <li>
                 <span class="divider">|</span> <a href="routing.html">Routing</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../index.html">Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="dispatchers.html">Dispatchers</a> <span class="divider">|</span>
              </li>
              <li>
                Version 2.2.3
              </li>
            </ul>
          </div>
        </div>
        <div class="row">
          <div class="span9">
            <div id="cse">Loading</div>
          </div><div class="span9">
            
  <div class="section" id="mailboxes">
<span id="mailboxes-java"></span><h1>Mailboxes</h1>
<p>An Akka <tt class="docutils literal"><span class="pre">Mailbox</span></tt> holds the messages that are destined for an <tt class="docutils literal"><span class="pre">Actor</span></tt>.
Normally each <tt class="docutils literal"><span class="pre">Actor</span></tt> has its own mailbox, but with for example a <tt class="docutils literal"><span class="pre">BalancingDispatcher</span></tt>
all actors with the same <tt class="docutils literal"><span class="pre">BalancingDispatcher</span></tt> will share a single instance.</p>
<div class="section" id="mailbox-selection">
<h2>Mailbox Selection</h2>
<div class="section" id="requiring-a-message-queue-type-for-an-actor">
<h3>Requiring a Message Queue Type for an Actor</h3>
<p>It is possible to require a certain type of message queue for a certain type of actor
by having that actor implement the parameterized interface <tt class="xref py py-class docutils literal"><span class="pre">RequiresMessageQueue</span></tt>. Here is
an example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.dispatch.BoundedMessageQueueSemantics</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.dispatch.RequiresMessageQueue</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">MyBoundedUntypedActor</span> <span class="k">extends</span> <span class="nc">MyUntypedActor</span>
  <span class="n">implements</span> <span class="nc">RequiresMessageQueue</span><span class="o">&lt;</span><span class="nc">BoundedMessageQueueSemantics</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The type parameter to the <tt class="xref py py-class docutils literal"><span class="pre">RequiresMessageQueue</span></tt> interface needs to be mapped to a mailbox in
configuration like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">bounded</span><span class="o">-</span><span class="n">mailbox</span> <span class="o">{</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="k">type</span> <span class="o">=</span> <span class="s">&quot;akka.dispatch.BoundedMailbox&quot;</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="n">capacity</span> <span class="k">=</span> <span class="mi">1000</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="n">push</span><span class="o">-</span><span class="n">timeout</span><span class="o">-</span><span class="n">time</span> <span class="k">=</span> <span class="mi">10</span><span class="n">s</span>
<span class="o">}</span>

<span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">mailbox</span><span class="o">.</span><span class="n">requirements</span> <span class="o">{</span>
  <span class="s">&quot;akka.dispatch.BoundedMessageQueueSemantics&quot;</span> <span class="k">=</span> <span class="n">bounded</span><span class="o">-</span><span class="n">mailbox</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Now every time you create an actor of type <tt class="xref py py-class docutils literal"><span class="pre">MyBoundedUntypedActor</span></tt> it will try to get a bounded
mailbox. If the actor has a different mailbox configured in deployment, either directly or via
a dispatcher with a specified mailbox type, then that will override this mapping.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The type of the queue in the mailbox created for an actor will be checked against the required type in the
interface and if the queue doesn't implement the required type then actor creation will fail.</p>
</div>
</div>
<div class="section" id="requiring-a-message-queue-type-for-a-dispatcher">
<h3>Requiring a Message Queue Type for a Dispatcher</h3>
<p>A dispatcher may also have a requirement for the mailbox type used by the
actors running on it. An example is the BalancingDispatcher which requires a
message queue that is thread-safe for multiple concurrent consumers. Such a
requirement is formulated within the dispatcher configuration section like
this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">my</span><span class="o">-</span><span class="n">dispatcher</span> <span class="o">{</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="n">requirement</span> <span class="k">=</span> <span class="n">org</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="nc">MyInterface</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The given requirement names a class or interface which will then be ensured to
be a supertype of the message queue’s implementation. In case of a
conflict—e.g. if the actor requires a mailbox type which does not satisfy this
requirement—then actor creation will fail.</p>
</div>
<div class="section" id="how-the-mailbox-type-is-selected">
<h3>How the Mailbox Type is Selected</h3>
<p>When an actor is created, the <tt class="xref py py-class docutils literal"><span class="pre">ActorRefProvider</span></tt> first determines the
dispatcher which will execute it. Then the mailbox is determined as follows:</p>
<ol class="arabic simple">
<li>If the actor’s deployment configuration section contains a <tt class="docutils literal"><span class="pre">mailbox</span></tt> key
then that names a configuration section describing the mailbox type to be
used.</li>
<li>If the actor’s <tt class="docutils literal"><span class="pre">Props</span></tt> contains a mailbox selection—i.e. <tt class="docutils literal"><span class="pre">withMailbox</span></tt>
was called on it—then that names a configuration section describing the
mailbox type to be used.</li>
<li>If the dispatcher’s configuration section contains a <tt class="docutils literal"><span class="pre">mailbox-type</span></tt> key
the same section will be used to configure the mailbox type.</li>
<li>If the actor requires a mailbox type as described above then the mapping for
that requirement will be used to determine the mailbox type to be used; if
that fails then the dispatcher’s requirement—if any—will be tried instead.</li>
<li>If the dispatcher requires a mailbox type as described above then the
mapping for that requirement will be used to determine the mailbox type to
be used.</li>
<li>The default mailbox <tt class="docutils literal"><span class="pre">akka.actor.default-mailbox</span></tt> will be used.</li>
</ol>
</div>
<div class="section" id="default-mailbox">
<h3>Default Mailbox</h3>
<p>When the mailbox is not specified as described above the default mailbox
is used. By default it is an unbounded mailbox, which is backed by a
<tt class="docutils literal"><span class="pre">java.util.concurrent.ConcurrentLinkedQueue</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">SingleConsumerOnlyUnboundedMailbox</span></tt> is an even more efficient mailbox, and
it can be used as the default mailbox, but it cannot be used with a BalancingDispatcher.</p>
<p>Configuration of <tt class="docutils literal"><span class="pre">SingleConsumerOnlyUnboundedMailbox</span></tt> as default mailbox:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">default</span><span class="o">-</span><span class="n">mailbox</span> <span class="o">{</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="k">type</span> <span class="o">=</span> <span class="s">&quot;akka.dispatch.SingleConsumerOnlyUnboundedMailbox&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="which-configuration-is-passed-to-the-mailbox-type">
<h3>Which Configuration is passed to the Mailbox Type</h3>
<p>Each mailbox type is implemented by a class which extends <tt class="xref py py-class docutils literal"><span class="pre">MailboxType</span></tt>
and takes two constructor arguments: a <tt class="xref py py-class docutils literal"><span class="pre">ActorSystem.Settings</span></tt> object and
a <tt class="xref py py-class docutils literal"><span class="pre">Config</span></tt> section. The latter is computed by obtaining the named
configuration section from the actor system’s configuration, overriding its
<tt class="docutils literal"><span class="pre">id</span></tt> key with the configuration path of the mailbox type and adding a
fall-back to the default mailbox configuration section.</p>
</div>
</div>
<div class="section" id="builtin-mailbox-implementations">
<h2>Builtin Mailbox Implementations</h2>
<p>Akka comes shipped with a number of mailbox implementations:</p>
<ul class="simple">
<li>UnboundedMailbox
- The default mailbox<ul>
<li>Backed by a <tt class="docutils literal"><span class="pre">java.util.concurrent.ConcurrentLinkedQueue</span></tt></li>
<li>Blocking: No</li>
<li>Bounded: No</li>
<li>Configuration name: &quot;unbounded&quot; or &quot;akka.dispatch.UnboundedMailbox&quot;</li>
</ul>
</li>
<li>SingleConsumerOnlyUnboundedMailbox<ul>
<li>Backed by a very efficient Multiple Producer Single Consumer queue, cannot be used with BalancingDispatcher</li>
<li>Blocking: No</li>
<li>Bounded: No</li>
<li>Configuration name: &quot;akka.dispatch.SingleConsumerOnlyUnboundedMailbox&quot;</li>
</ul>
</li>
<li>BoundedMailbox<ul>
<li>Backed by a <tt class="docutils literal"><span class="pre">java.util.concurrent.LinkedBlockingQueue</span></tt></li>
<li>Blocking: Yes</li>
<li>Bounded: Yes</li>
<li>Configuration name: &quot;bounded&quot; or &quot;akka.dispatch.BoundedMailbox&quot;</li>
</ul>
</li>
<li>UnboundedPriorityMailbox<ul>
<li>Backed by a <tt class="docutils literal"><span class="pre">java.util.concurrent.PriorityBlockingQueue</span></tt></li>
<li>Blocking: Yes</li>
<li>Bounded: No</li>
<li>Configuration name: &quot;akka.dispatch.UnboundedPriorityMailbox&quot;</li>
</ul>
</li>
<li>BoundedPriorityMailbox<ul>
<li>Backed by a <tt class="docutils literal"><span class="pre">java.util.PriorityBlockingQueue</span></tt> wrapped in an <tt class="docutils literal"><span class="pre">akka.util.BoundedBlockingQueue</span></tt></li>
<li>Blocking: Yes</li>
<li>Bounded: Yes</li>
<li>Configuration name: &quot;akka.dispatch.BoundedPriorityMailbox&quot;</li>
</ul>
</li>
<li>Durable mailboxes, see <a class="reference internal" href="durable-mailbox.html#durable-mailboxes-java"><em>Durable Mailboxes</em></a>.</li>
</ul>
</div>
<div class="section" id="mailbox-configuration-examples">
<h2>Mailbox configuration examples</h2>
<p>How to create a PriorityMailbox:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">MyPrioMailbox</span> <span class="k">extends</span> <span class="nc">UnboundedPriorityMailbox</span> <span class="o">{</span>
  <span class="c1">// needed for reflective instantiation</span>
  <span class="n">public</span> <span class="nc">MyPrioMailbox</span><span class="o">(</span><span class="nc">ActorSystem</span><span class="o">.</span><span class="nc">Settings</span> <span class="n">settings</span><span class="o">,</span> <span class="nc">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Create a new PriorityGenerator, lower prio means more important</span>
    <span class="k">super</span><span class="o">(</span><span class="k">new</span> <span class="nc">PriorityGenerator</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="n">public</span> <span class="n">int</span> <span class="n">gen</span><span class="o">(</span><span class="nc">Object</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;highpriority&quot;</span><span class="o">))</span>
          <span class="k">return</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// &#39;highpriority messages should be treated first if possible</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;lowpriority&quot;</span><span class="o">))</span>
          <span class="k">return</span> <span class="mi">2</span><span class="o">;</span> <span class="c1">// &#39;lowpriority messages should be treated last if possible</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="nc">PoisonPill</span><span class="o">.</span><span class="n">getInstance</span><span class="o">()))</span>
          <span class="k">return</span> <span class="mi">3</span><span class="o">;</span> <span class="c1">// PoisonPill when no other left</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// By default they go between high and low prio</span>
      <span class="o">}</span>
    <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And then add it to the configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">prio</span><span class="o">-</span><span class="n">dispatcher</span> <span class="o">{</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="k">type</span> <span class="o">=</span> <span class="s">&quot;docs.dispatcher.DispatcherDocSpec$MyPrioMailbox&quot;</span>
  <span class="c1">//Other dispatcher configuration goes here</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And then an example on how you would use it:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Demo</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
  <span class="nc">LoggingAdapter</span> <span class="n">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">.</span><span class="n">getLogger</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="n">system</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>
  <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span> <span class="k">:</span> <span class="kt">new</span> <span class="kt">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&quot;lowpriority&quot;</span><span class="o">,</span> <span class="s">&quot;lowpriority&quot;</span><span class="o">,</span>
        <span class="s">&quot;highpriority&quot;</span><span class="o">,</span> <span class="s">&quot;pigdog&quot;</span><span class="o">,</span> <span class="s">&quot;pigdog2&quot;</span><span class="o">,</span> <span class="s">&quot;pigdog3&quot;</span><span class="o">,</span> <span class="s">&quot;highpriority&quot;</span><span class="o">,</span>
        <span class="nc">PoisonPill</span><span class="o">.</span><span class="n">getInstance</span><span class="o">()</span> <span class="o">})</span> <span class="o">{</span>
      <span class="n">getSelf</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="n">toString</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// We create a new Actor that just prints out what it processes</span>
<span class="nc">ActorRef</span> <span class="n">myActor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">Demo</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>
    <span class="o">.</span><span class="n">withDispatcher</span><span class="o">(</span><span class="s">&quot;prio-dispatcher&quot;</span><span class="o">));</span>

<span class="cm">/*</span>
<span class="cm">Logs:</span>
<span class="cm">  &#39;highpriority</span>
<span class="cm">  &#39;highpriority</span>
<span class="cm">  &#39;pigdog</span>
<span class="cm">  &#39;pigdog2</span>
<span class="cm">  &#39;pigdog3</span>
<span class="cm">  &#39;lowpriority</span>
<span class="cm">  &#39;lowpriority</span>
<span class="cm">*/</span>
</pre></div>
</div>
<p>It is also possible to configure a mailbox type directly like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">prio</span><span class="o">-</span><span class="n">mailbox</span> <span class="o">{</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="k">type</span> <span class="o">=</span> <span class="s">&quot;docs.dispatcher.DispatcherDocSpec$MyPrioMailbox&quot;</span>
  <span class="c1">//Other mailbox configuration goes here</span>
<span class="o">}</span>

<span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">deployment</span> <span class="o">{</span>
  <span class="o">/</span><span class="n">priomailboxactor</span> <span class="o">{</span>
    <span class="n">mailbox</span> <span class="k">=</span> <span class="n">prio</span><span class="o">-</span><span class="n">mailbox</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And then use it either from deployment like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">myActor</span> <span class="k">=</span>
  <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">MyUntypedActor</span><span class="o">.</span><span class="n">class</span><span class="o">),</span>
    <span class="s">&quot;priomailboxactor&quot;</span><span class="o">);</span>
</pre></div>
</div>
<p>Or code like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="nc">ActorRef</span> <span class="n">myActor</span> <span class="k">=</span>
  <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">MyUntypedActor</span><span class="o">.</span><span class="n">class</span><span class="o">)</span>
    <span class="o">.</span><span class="n">withMailbox</span><span class="o">(</span><span class="s">&quot;prio-mailbox&quot;</span><span class="o">));</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-your-own-mailbox-type">
<h2>Creating your own Mailbox type</h2>
<p>An example is worth a thousand quacks:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.dispatch.Envelope</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.dispatch.MailboxType</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.dispatch.MessageQueue</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.dispatch.ProducesMessageQueue</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">com.typesafe.config.Config</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.ConcurrentLinkedQueue</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Queue</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">scala.Option</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">MyUnboundedJMailbox</span> <span class="n">implements</span> <span class="nc">MailboxType</span><span class="o">,</span>
  <span class="nc">ProducesMessageQueue</span><span class="o">&lt;</span><span class="nc">MyUnboundedJMailbox</span><span class="o">.</span><span class="nc">MyMessageQueue</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="c1">// This is the MessageQueue implementation</span>
  <span class="n">public</span> <span class="n">static</span> <span class="k">class</span> <span class="nc">MyMessageQueue</span> <span class="n">implements</span> <span class="nc">MessageQueue</span><span class="o">,</span>
    <span class="nc">MyUnboundedJMessageQueueSemantics</span> <span class="o">{</span>
    <span class="k">private</span> <span class="k">final</span> <span class="nc">Queue</span><span class="o">&lt;</span><span class="nc">Envelope</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="k">=</span>
      <span class="k">new</span> <span class="nc">ConcurrentLinkedQueue</span><span class="o">&lt;</span><span class="nc">Envelope</span><span class="o">&gt;();</span>

    <span class="c1">// these must be implemented; queue used as example</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">enqueue</span><span class="o">(</span><span class="nc">ActorRef</span> <span class="n">receiver</span><span class="o">,</span> <span class="nc">Envelope</span> <span class="n">handle</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">queue</span><span class="o">.</span><span class="n">offer</span><span class="o">(</span><span class="n">handle</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">public</span> <span class="nc">Envelope</span> <span class="n">dequeue</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="n">poll</span><span class="o">();</span> <span class="o">}</span>
    <span class="n">public</span> <span class="n">int</span> <span class="n">numberOfMessages</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="n">size</span><span class="o">();</span> <span class="o">}</span>
    <span class="n">public</span> <span class="n">boolean</span> <span class="n">hasMessages</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">queue</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">();</span> <span class="o">}</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">cleanUp</span><span class="o">(</span><span class="nc">ActorRef</span> <span class="n">owner</span><span class="o">,</span> <span class="nc">MessageQueue</span> <span class="n">deadLetters</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Envelope</span> <span class="n">handle</span><span class="k">:</span> <span class="kt">queue</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">deadLetters</span><span class="o">.</span><span class="n">enqueue</span><span class="o">(</span><span class="n">owner</span><span class="o">,</span> <span class="n">handle</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// This constructor signature must exist, it will be called by Akka</span>
  <span class="n">public</span> <span class="nc">MyUnboundedJMailbox</span><span class="o">(</span><span class="nc">ActorSystem</span><span class="o">.</span><span class="nc">Settings</span> <span class="n">settings</span><span class="o">,</span> <span class="nc">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// put your initialization code here</span>
  <span class="o">}</span>

  <span class="c1">// The create method is called to create the MessageQueue</span>
  <span class="n">public</span> <span class="nc">MessageQueue</span> <span class="n">create</span><span class="o">(</span><span class="nc">Option</span><span class="o">&lt;</span><span class="nc">ActorRef</span><span class="o">&gt;</span> <span class="n">owner</span><span class="o">,</span> <span class="nc">Option</span><span class="o">&lt;</span><span class="nc">ActorSystem</span><span class="o">&gt;</span> <span class="n">system</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">MyMessageQueue</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span class="c1">// Marker interface used for mailbox requirements mapping</span>
<span class="n">public</span> <span class="n">interface</span> <span class="nc">MyUnboundedJMessageQueueSemantics</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And then you just specify the FQCN of your MailboxType as the value of the &quot;mailbox-type&quot; in the dispatcher
configuration, or the mailbox configuration.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure to include a constructor which takes
<tt class="docutils literal"><span class="pre">akka.actor.ActorSystem.Settings</span></tt> and <tt class="docutils literal"><span class="pre">com.typesafe.config.Config</span></tt>
arguments, as this constructor is invoked reflectively to construct your
mailbox type. The config passed in as second argument is that section from
the configuration which describes the dispatcher or mailbox setting using
this mailbox type; the mailbox type will be instantiated once for each
dispatcher or mailbox setting using it.</p>
</div>
<p>You can also use the mailbox as a requirement on the dispatcher like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">custom</span><span class="o">-</span><span class="n">dispatcher</span> <span class="o">{</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="n">requirement</span> <span class="k">=</span>
  <span class="s">&quot;docs.dispatcher.MyUnboundedJMessageQueueSemantics&quot;</span>
<span class="o">}</span>

<span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">mailbox</span><span class="o">.</span><span class="n">requirements</span> <span class="o">{</span>
  <span class="s">&quot;docs.dispatcher.MyUnboundedJMessageQueueSemantics&quot;</span> <span class="k">=</span>
  <span class="n">custom</span><span class="o">-</span><span class="n">dispatcher</span><span class="o">-</span><span class="n">mailbox</span>
<span class="o">}</span>

<span class="n">custom</span><span class="o">-</span><span class="n">dispatcher</span><span class="o">-</span><span class="n">mailbox</span> <span class="o">{</span>
  <span class="n">mailbox</span><span class="o">-</span><span class="k">type</span> <span class="o">=</span> <span class="s">&quot;docs.dispatcher.MyUnboundedJMailbox&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Or by defining the requirement on your actor class like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">public</span> <span class="k">class</span> <span class="nc">MySpecialActor</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="n">implements</span>
  <span class="nc">RequiresMessageQueue</span><span class="o">&lt;</span><span class="nc">MyUnboundedJMessageQueueSemantics</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="special-semantics-of-system-actorof">
<h2>Special Semantics of <tt class="docutils literal"><span class="pre">system.actorOf</span></tt></h2>
<p>In order to make <tt class="docutils literal"><span class="pre">system.actorOf</span></tt> both synchronous and non-blocking while
keeping the return type <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt> (and the semantics that the returned
ref is fully functional), special handling takes place for this case. Behind
the scenes, a hollow kind of actor reference is constructed, which is sent to
the system’s guardian actor who actually creates the actor and its context and
puts those inside the reference. Until that has happened, messages sent to the
<tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt> will be queued locally, and only upon swapping the real
filling in will they be transferred into the real mailbox. Thus,</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">Props</span> <span class="n">props</span> <span class="k">=</span> <span class="o">...</span>
<span class="c1">// this actor uses MyCustomMailbox, which is assumed to be a singleton</span>
<span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="n">props</span><span class="o">.</span><span class="n">withDispatcher</span><span class="o">(</span><span class="s">&quot;myCustomMailbox&quot;</span><span class="o">).</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;bang&quot;</span><span class="o">,</span> <span class="n">sender</span><span class="o">);</span>
<span class="n">assert</span><span class="o">(</span><span class="nc">MyCustomMailbox</span><span class="o">.</span><span class="n">getInstance</span><span class="o">().</span><span class="n">getLastEnqueued</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;bang&quot;</span><span class="o">));</span>
</pre></div>
</div>
<p>will probably fail; you will have to allow for some time to pass and retry the
check à la <tt class="xref py py-meth docutils literal"><span class="pre">TestKit.awaitCond</span></tt>.</p>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://akka.io/faq">FAQ</a></li>
      <li><a href="http://typesafe.com/stack/downloads/akka">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>      
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>      
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://typesafe.com/products/typesafe-subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@typesafe.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/watermark.png" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2013 <a href="http://typesafe.com/">Typesafe Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Oct 23, 2013
    </p>          
  </div>
</div>
<script src="http://www.google.com/jsapi" type="text/javascript"></script>
<script type="text/javascript">
    google.load('search', '1', {language : 'en', style : google.loader.themes.MINIMALIST});
    google.setOnLoadCallback(function() {
    var customSearchOptions = {};  var customSearchControl = new google.search.CustomSearchControl(
    '003065520604945464838:izzukx8-qba', customSearchOptions);
    customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);
    customSearchControl.draw('cse');
    var path = window.location.pathname.split('/').slice(0,4);
    if(window.location.hostname && path.length >= 4) {
    var site = "site:" + window.location.hostname + path.join('/').toString();
    customSearchControl.setSearchStartingCallback(this, function(c, s, q) { s.setQueryAddition(site); });
    }
    }, true);
</script>
<style type="text/css">
    .gsc-control-cse {
    font-family: Arial, sans-serif;
    border-color: rgb(242, 242, 235);
    background-color: rgb(242, 242, 235);
    }
    .gsc-control-cse .gsc-table-result {
      font-family: Arial, sans-serif;
      display: block;
    }
    input.gsc-input {
    border-color: #BBBBBB;
    }
    input.gsc-search-button {
    border-color: rgb(34, 57, 64);
    background-color: rgb(68, 114, 129);
    color: #FFFFFF;
    }
    .gsc-tabHeader.gsc-tabhInactive {
    border-color: #777777;
    background-color: #777777;
    }
    .gsc-tabHeader.gsc-tabhActive {
    border-color: #333333;
    background-color: #333333;
    }
    .gsc-tabsArea {
    border-color: #333333;
    }
    .gsc-webResult.gsc-result,
    .gsc-results .gsc-imageResult {
      border-color: #666666;
      background-color: #FFFFFF;
      padding: 0.5em 0.5em;
    }
    .gsc-webResult.gsc-result:hover,
    .gsc-imageResult:hover {
      border-color: #AAAAAA;
      background-color: #FFFFFF;
      padding: 0.5em 0.5em;
    }
    .gsc-webResult.gsc-result.gsc-promotion:hover {
    border-color: #AAAAAA;
    background-color: #FFFFFF;
    }
    .gs-webResult.gs-result a.gs-title:link,
    .gs-webResult.gs-result a.gs-title:link b,
    .gs-imageResult a.gs-title:link,
    .gs-imageResult a.gs-title:link b {
    color: #444444;
    }
    .gs-webResult.gs-result a.gs-title:visited,
    .gs-webResult.gs-result a.gs-title:visited b,
    .gs-imageResult a.gs-title:visited,
    .gs-imageResult a.gs-title:visited b {
    color: #444444;
    }
    .gs-webResult.gs-result a.gs-title:hover,
    .gs-webResult.gs-result a.gs-title:hover b,
    .gs-imageResult a.gs-title:hover,
    .gs-imageResult a.gs-title:hover b {
    color: #444444;
    }
    .gs-webResult.gs-result a.gs-title:active,
    .gs-webResult.gs-result a.gs-title:active b,
    .gs-imageResult a.gs-title:active,
    .gs-imageResult a.gs-title:active b {
    color: #777777;
    }
    .gsc-cursor-page {
    color: #444444;
    }
    a.gsc-trailing-more-results:link {
    color: #444444;
    }
    .gs-webResult .gs-snippet,
    .gs-imageResult .gs-snippet,
    .gs-fileFormatType {
    color: #333333;
    }
    .gs-webResult div.gs-visibleUrl,
    .gs-imageResult div.gs-visibleUrl {
    color: #000000;
    }
    .gs-webResult div.gs-visibleUrl-short {
    color: #000000;
    }
    .gs-webResult div.gs-visibleUrl-short {
    display: none;
    }
    .gs-webResult div.gs-visibleUrl-long {
    display: block;
    }
    .gs-promotion div.gs-visibleUrl-short {
    display: none;
    }
    .gs-promotion div.gs-visibleUrl-long {
    display: block;
    }
    .gsc-cursor-box {
    border-color: #FFFFFF;
    }
    .gsc-results .gsc-cursor-box .gsc-cursor-page {
    border-color: #777777;
    background-color: #FFFFFF;
    color: #444444;
    }
    .gsc-results .gsc-cursor-box .gsc-cursor-current-page {
    border-color: #333333;
    background-color: #333333;
    color: #444444;
    }
    .gsc-webResult.gsc-result.gsc-promotion {
    border-color: #CCCCCC;
    background-color: #E6E6E6;
    }
    .gsc-completion-title {
    color: #444444;
    }
    .gsc-completion-snippet {
    color: #333333;
    }
    .gs-promotion a.gs-title:link,
    .gs-promotion a.gs-title:link *,
    .gs-promotion .gs-snippet a:link {
    color: #0000CC;
    }
    .gs-promotion a.gs-title:visited,
    .gs-promotion a.gs-title:visited *,
    .gs-promotion .gs-snippet a:visited {
    color: #0000CC;
    }
    .gs-promotion a.gs-title:hover,
    .gs-promotion a.gs-title:hover *,
    .gs-promotion .gs-snippet a:hover {
    color: #444444;
    }
    .gs-promotion a.gs-title:active,
    .gs-promotion a.gs-title:active *,
    .gs-promotion .gs-snippet a:active {
    color: #00CC00;
    }
    .gs-promotion .gs-snippet,
    .gs-promotion .gs-title .gs-promotion-title-right,
    .gs-promotion .gs-title .gs-promotion-title-right *  {
    color: #333333;
    }
    .gs-promotion .gs-visibleUrl,
    .gs-promotion .gs-visibleUrl-short {
    color: #00CC00;
    }
</style>
<script type="text/javascript">
  $('#toc').toc();
</script>
  

  </body>
</html>