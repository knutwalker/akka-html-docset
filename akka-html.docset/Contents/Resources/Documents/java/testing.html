

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Testing Actor Systems &mdash; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Exo:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Actors" href="index-actors.html" />
    <link rel="next" title="Futures and Agents" href="index-futures.html" />
    <link rel="prev" title="Building Finite State Machine Actors" href="fsm.html" />

  </head>
  <body>
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img src="../_static/logo-small.png" /></a>
        </div>    
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://akka.io/faq">FAQ</a></li>
          <li><a href="http://typesafe.com/stack/downloads/akka">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>           
          <li><a href="http://typesafe.com/products/typesafe-subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Testing Actor Systems</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">           
              <li>
                 <span class="divider">|</span> <a href="index-futures.html">Futures and Agents</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../index.html">Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="fsm.html">Building Finite State Machine Actors</a> <span class="divider">|</span>
              </li>
              <li>
                Version 2.2.3
              </li>
            </ul>
          </div>
        </div>
        <div class="row"><div class="span9">
            
  <div class="section" id="testing-actor-systems">
<span id="akka-testkit-java"></span><h1>Testing Actor Systems</h1>
<p>As with any piece of software, automated tests are a very important part of the
development cycle. The actor model presents a different view on how units of
code are delimited and how they interact, which has an influence on how to
perform tests.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Due to the conciseness of test DSLs available for Scala (<a class="reference external" href="http://scalatest.org/">ScalaTest</a>,
<a class="reference external" href="http://specs2.org/">Specs2</a>, <a class="reference external" href="http://code.google.com/p/scalacheck/">ScalaCheck</a>), it may be a good idea to write the test suite in
that language even if the main project is written in Java. If that is not
desirable, you can also use <tt class="xref py py-class docutils literal"><span class="pre">TestKit</span></tt> and friends from Java, albeit
with more verbose syntax which is covered below. Munish Gupta has <a class="reference external" href="http://www.akkaessentials.in/2012/05/using-testkit-with-java.html">published
a nice post</a> showing
several patterns you may find useful.</p>
</div>
<p>Akka comes with a dedicated module <tt class="xref py py-mod docutils literal"><span class="pre">akka-testkit</span></tt> for supporting tests at
different levels, which fall into two clearly distinct categories:</p>
<blockquote>
<div><ul class="simple">
<li>Testing isolated pieces of code without involving the actor model, meaning
without multiple threads; this implies completely deterministic behavior
concerning the ordering of events and no concurrency concerns and will be
called <strong>Unit Testing</strong> in the following.</li>
<li>Testing (multiple) encapsulated actors including multi-threaded scheduling;
this implies non-deterministic order of events but shielding from
concurrency concerns by the actor model and will be called <strong>Integration
Testing</strong> in the following.</li>
</ul>
</div></blockquote>
<p>There are of course variations on the granularity of tests in both categories,
where unit testing reaches down to white-box tests and integration testing can
encompass functional tests of complete actor networks. The important
distinction lies in whether concurrency concerns are part of the test or not.
The tools offered are described in detail in the following sections.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Be sure to add the module <tt class="xref py py-mod docutils literal"><span class="pre">akka-testkit</span></tt> to your dependencies.</p>
</div>
<div class="section" id="synchronous-unit-testing-with-testactorref">
<h2>Synchronous Unit Testing with <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt></h2>
<p>Testing the business logic inside <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt> classes can be divided into
two parts: first, each atomic operation must work in isolation, then sequences
of incoming events must be processed correctly, even in the presence of some
possible variability in the ordering of events. The former is the primary use
case for single-threaded unit testing, while the latter can only be verified in
integration tests.</p>
<p>Normally, the <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt> shields the underlying <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt> instance
from the outside, the only communications channel is the actor's mailbox. This
restriction is an impediment to unit testing, which led to the inception of the
<tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt>. This special type of reference is designed specifically
for test purposes and allows access to the actor in two ways: either by
obtaining a reference to the underlying actor instance, or by invoking or
querying the actor's behaviour (<tt class="xref py py-meth docutils literal"><span class="pre">receive</span></tt>). Each one warrants its own
section below.</p>
<div class="section" id="obtaining-a-reference-to-an-actor">
<h3>Obtaining a Reference to an <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt></h3>
<p>Having access to the actual <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt> object allows application of all
traditional unit testing techniques on the contained methods. Obtaining a
reference is done like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">static</span> <span class="k">class</span> <span class="nc">MyActor</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="n">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;say42&quot;</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">getSender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="n">instanceof</span> <span class="nc">Exception</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="o">(</span><span class="nc">Exception</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">public</span> <span class="n">boolean</span> <span class="n">testMe</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="n">public</span> <span class="n">void</span> <span class="n">demonstrateTestActorRef</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">final</span> <span class="nc">Props</span> <span class="n">props</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">MyActor</span><span class="o">.</span><span class="n">class</span><span class="o">);</span>
  <span class="k">final</span> <span class="nc">TestActorRef</span><span class="o">&lt;</span><span class="nc">MyActor</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="k">=</span> <span class="nc">TestActorRef</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">system</span><span class="o">,</span> <span class="n">props</span><span class="o">,</span> <span class="s">&quot;testA&quot;</span><span class="o">);</span>
  <span class="k">final</span> <span class="nc">MyActor</span> <span class="n">actor</span> <span class="k">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">underlyingActor</span><span class="o">();</span>
  <span class="n">assertTrue</span><span class="o">(</span><span class="n">actor</span><span class="o">.</span><span class="n">testMe</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Since <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt> is generic in the actor type it returns the
underlying actor with its proper static type. From this point on you may bring
any unit testing tool to bear on your actor as usual.</p>
</div>
<div class="section" id="testing-the-actor-s-behavior">
<h3>Testing the Actor's Behavior</h3>
<p>When the dispatcher invokes the processing behavior of an actor on a message,
it actually calls <tt class="xref py py-meth docutils literal"><span class="pre">apply</span></tt> on the current behavior registered for the
actor. This starts out with the return value of the declared <tt class="xref py py-meth docutils literal"><span class="pre">receive</span></tt>
method, but it may also be changed using <tt class="xref py py-meth docutils literal"><span class="pre">become</span></tt> and <tt class="xref py py-meth docutils literal"><span class="pre">unbecome</span></tt> in
response to external messages. All of this contributes to the overall actor
behavior and it does not lend itself to easy testing on the <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt>
itself. Therefore the <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt> offers a different mode of
operation to complement the <tt class="xref py py-class docutils literal"><span class="pre">Actor</span></tt> testing: it supports all operations
also valid on normal <tt class="xref py py-class docutils literal"><span class="pre">ActorRef</span></tt>. Messages sent to the actor are
processed synchronously on the current thread and answers may be sent back as
usual. This trick is made possible by the <tt class="xref py py-class docutils literal"><span class="pre">CallingThreadDispatcher</span></tt>
described below (see <a class="reference internal" href="#callingthreaddispatcher">CallingThreadDispatcher</a>); this dispatcher is set
implicitly for any actor instantiated into a <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">Props</span> <span class="n">props</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">MyActor</span><span class="o">.</span><span class="n">class</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">TestActorRef</span><span class="o">&lt;</span><span class="nc">MyActor</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="k">=</span> <span class="nc">TestActorRef</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">system</span><span class="o">,</span> <span class="n">props</span><span class="o">,</span> <span class="s">&quot;testB&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">future</span> <span class="k">=</span> <span class="n">akka</span><span class="o">.</span><span class="n">pattern</span><span class="o">.</span><span class="nc">Patterns</span><span class="o">.</span><span class="n">ask</span><span class="o">(</span><span class="n">ref</span><span class="o">,</span> <span class="s">&quot;say42&quot;</span><span class="o">,</span> <span class="mi">3000</span><span class="o">);</span>
<span class="n">assertTrue</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="n">isCompleted</span><span class="o">());</span>
<span class="n">assertEquals</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">future</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="nc">Zero</span><span class="o">()));</span>
</pre></div>
</div>
<p>As the <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt> is a subclass of <tt class="xref py py-class docutils literal"><span class="pre">LocalActorRef</span></tt> with a few
special extras, also aspects like supervision and restarting work properly, but
beware that execution is only strictly synchronous as long as all actors
involved use the <tt class="xref py py-class docutils literal"><span class="pre">CallingThreadDispatcher</span></tt>. As soon as you add elements
which include more sophisticated scheduling you leave the realm of unit testing
as you then need to think about asynchronicity again (in most cases the problem
will be to wait until the desired effect had a chance to happen).</p>
<p>One more special aspect which is overridden for single-threaded tests is the
<tt class="xref py py-meth docutils literal"><span class="pre">receiveTimeout</span></tt>, as including that would entail asynchronous queuing of
<tt class="xref py py-obj docutils literal"><span class="pre">ReceiveTimeout</span></tt> messages, violating the synchronous contract.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To summarize: <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt> overwrites two fields: it sets the
dispatcher to <tt class="xref py py-obj docutils literal"><span class="pre">CallingThreadDispatcher.global</span></tt> and it sets the
<tt class="xref py py-obj docutils literal"><span class="pre">receiveTimeout</span></tt> to None.</p>
</div>
</div>
<div class="section" id="the-way-in-between-expecting-exceptions">
<h3>The Way In-Between: Expecting Exceptions</h3>
<p>If you want to test the actor behavior, including hotswapping, but without
involving a dispatcher and without having the <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt> swallow
any thrown exceptions, then there is another mode available for you: just use
the <tt class="xref py py-meth docutils literal"><span class="pre">receive</span></tt> method <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt>, which will be forwarded to the
underlying actor:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">Props</span> <span class="n">props</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">MyActor</span><span class="o">.</span><span class="n">class</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">TestActorRef</span><span class="o">&lt;</span><span class="nc">MyActor</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="k">=</span> <span class="nc">TestActorRef</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">system</span><span class="o">,</span> <span class="n">props</span><span class="o">,</span> <span class="s">&quot;myActor&quot;</span><span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">ref</span><span class="o">.</span><span class="n">receive</span><span class="o">(</span><span class="k">new</span> <span class="nc">Exception</span><span class="o">(</span><span class="s">&quot;expected&quot;</span><span class="o">));</span>
  <span class="n">fail</span><span class="o">(</span><span class="s">&quot;expected an exception to be thrown&quot;</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;expected&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="use-cases">
<h3>Use Cases</h3>
<p>You may of course mix and match both modi operandi of <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt> as
suits your test needs:</p>
<blockquote>
<div><ul class="simple">
<li>one common use case is setting up the actor into a specific internal state
before sending the test message</li>
<li>another is to verify correct internal state transitions after having sent
the test message</li>
</ul>
</div></blockquote>
<p>Feel free to experiment with the possibilities, and if you find useful
patterns, don't hesitate to let the Akka forums know about them! Who knows,
common operations might even be worked into nice DSLs.</p>
</div>
</div>
<div class="section" id="asynchronous-integration-testing-with-javatestkit">
<h2>Asynchronous Integration Testing with <tt class="xref py py-class docutils literal"><span class="pre">JavaTestKit</span></tt></h2>
<p>When you are reasonably sure that your actor's business logic is correct, the
next step is verifying that it works correctly within its intended environment.
The definition of the environment depends of course very much on the problem at
hand and the level at which you intend to test, ranging for
functional/integration tests to full system tests. The minimal setup consists
of the test procedure, which provides the desired stimuli, the actor under
test, and an actor receiving replies.  Bigger systems replace the actor under
test with a network of actors, apply stimuli at varying injection points and
arrange results to be sent from different emission points, but the basic
principle stays the same in that a single procedure drives the test.</p>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">JavaTestKit</span></tt> class contains a collection of tools which makes this
common task easy.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">import</span> <span class="nn">org.junit.AfterClass</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">org.junit.Assert</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">org.junit.BeforeClass</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="k">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.actor.Props</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.actor.UntypedActor</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.testkit.JavaTestKit</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration.Duration</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">TestKitSampleTest</span> <span class="o">{</span>
  
  <span class="n">public</span> <span class="n">static</span> <span class="k">class</span> <span class="nc">SomeActor</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
    <span class="nc">ActorRef</span> <span class="n">target</span> <span class="k">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">getSender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;world&quot;</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">target</span><span class="o">.</span><span class="n">forward</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">getContext</span><span class="o">());</span>
      
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="n">instanceof</span> <span class="nc">ActorRef</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">target</span> <span class="k">=</span> <span class="o">(</span><span class="nc">ActorRef</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">getSender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;done&quot;</span><span class="o">,</span> <span class="n">getSelf</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="n">static</span> <span class="nc">ActorSystem</span> <span class="n">system</span><span class="o">;</span>
  
  <span class="nd">@BeforeClass</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="nd">@AfterClass</span>
  <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">teardown</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">JavaTestKit</span><span class="o">.</span><span class="n">shutdownActorSystem</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
    <span class="n">system</span> <span class="k">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">testIt</span><span class="o">()</span> <span class="o">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Wrap the whole test procedure within a testkit constructor </span>
<span class="cm">     * if you want to receive actor replies or use Within(), etc.</span>
<span class="cm">     */</span>
    <span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
      <span class="k">final</span> <span class="nc">Props</span> <span class="n">props</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">SomeActor</span><span class="o">.</span><span class="n">class</span><span class="o">);</span>
      <span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">subject</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="n">props</span><span class="o">);</span>

      <span class="c1">// can also use JavaTestKit “from the outside”</span>
      <span class="k">final</span> <span class="nc">JavaTestKit</span> <span class="n">probe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
      <span class="c1">// “inject” the probe by passing it to the test subject</span>
      <span class="c1">// like a real resource would be passed in production</span>
      <span class="n">subject</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">probe</span><span class="o">.</span><span class="n">getRef</span><span class="o">(),</span> <span class="n">getRef</span><span class="o">());</span>
      <span class="c1">// await the correct response</span>
      <span class="n">expectMsgEquals</span><span class="o">(</span><span class="n">duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">),</span> <span class="s">&quot;done&quot;</span><span class="o">);</span>
      
      <span class="c1">// the run() method needs to finish within 3 seconds</span>
      <span class="k">new</span> <span class="nc">Within</span><span class="o">(</span><span class="n">duration</span><span class="o">(</span><span class="s">&quot;3 seconds&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">protected</span> <span class="n">void</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>

          <span class="n">subject</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="n">getRef</span><span class="o">());</span>

          <span class="c1">// This is a demo: would normally use expectMsgEquals().</span>
          <span class="c1">// Wait time is bounded by 3-second deadline above.</span>
          <span class="k">new</span> <span class="nc">AwaitCond</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">protected</span> <span class="n">boolean</span> <span class="n">cond</span><span class="o">()</span> <span class="o">{</span>
              <span class="k">return</span> <span class="n">probe</span><span class="o">.</span><span class="n">msgAvailable</span><span class="o">();</span>
            <span class="o">}</span>
          <span class="o">};</span>

          <span class="c1">// response must have been enqueued to us before probe</span>
          <span class="n">expectMsgEquals</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="nc">Zero</span><span class="o">(),</span> <span class="s">&quot;world&quot;</span><span class="o">);</span>
          <span class="c1">// check that the probe we injected earlier got the msg</span>
          <span class="n">probe</span><span class="o">.</span><span class="n">expectMsgEquals</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="nc">Zero</span><span class="o">(),</span> <span class="s">&quot;hello&quot;</span><span class="o">);</span>
          <span class="nc">Assert</span><span class="o">.</span><span class="n">assertEquals</span><span class="o">(</span><span class="n">getRef</span><span class="o">(),</span> <span class="n">probe</span><span class="o">.</span><span class="n">getLastSender</span><span class="o">());</span>

          <span class="c1">// Will wait for the rest of the 3 seconds</span>
          <span class="n">expectNoMsg</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">};</span>
    <span class="o">}};</span>
  <span class="o">}</span>
  
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">JavaTestKit</span></tt> contains an actor named <tt class="xref py py-obj docutils literal"><span class="pre">testActor</span></tt> which is the
entry point for messages to be examined with the various <tt class="docutils literal"><span class="pre">expectMsg...</span></tt>
assertions detailed below. The test actor’s reference is obtained using the
<tt class="xref py py-meth docutils literal"><span class="pre">getRef</span></tt> method as demonstrated above.  The <tt class="xref py py-obj docutils literal"><span class="pre">testActor</span></tt> may also
be passed to other actors as usual, usually subscribing it as notification
listener. There is a whole set of examination methods, e.g. receiving all
consecutive messages matching certain criteria, receiving a whole sequence of
fixed messages or classes, receiving nothing for some time, etc.</p>
<p>The ActorSystem passed in to the constructor of JavaTestKit is accessible via the
<tt class="xref py py-meth docutils literal"><span class="pre">getSystem</span></tt> method.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Remember to shut down the actor system after the test is finished (also in
case of failure) so that all actors—including the test actor—are stopped.</p>
</div>
<div class="section" id="built-in-assertions">
<h3>Built-In Assertions</h3>
<p>The above mentioned <tt class="xref py py-meth docutils literal"><span class="pre">expectMsgEquals</span></tt> is not the only method for
formulating assertions concerning received messages, the full set is this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">final</span> <span class="nc">String</span> <span class="n">hello</span> <span class="k">=</span> <span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Object</span>   <span class="n">any</span> <span class="k">=</span> <span class="n">expectMsgAnyOf</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="s">&quot;world&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">all</span> <span class="k">=</span> <span class="n">expectMsgAllOf</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="s">&quot;world&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="n">int</span> <span class="n">i</span>        <span class="k">=</span> <span class="n">expectMsgClass</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="n">class</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Number</span> <span class="n">j</span>     <span class="k">=</span> <span class="n">expectMsgAnyClassOf</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="nc">Long</span><span class="o">.</span><span class="n">class</span><span class="o">);</span>
<span class="n">expectNoMsg</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">two</span> <span class="k">=</span> <span class="n">receiveN</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</pre></div>
</div>
<p>In these examples, the maximum durations you will find mentioned below are left
out, in which case they use the default value from configuration item
<tt class="docutils literal"><span class="pre">akka.test.single-expect-default</span></tt> which itself defaults to 3 seconds (or they
obey the innermost enclosing <tt class="xref py py-class docutils literal"><span class="pre">Within</span></tt> as detailed <a class="reference internal" href="#javatestkit-within"><em>below</em></a>). The full signatures are:</p>
<blockquote>
<div><ul>
<li><p class="first"><tt class="xref py py-meth docutils literal"><span class="pre">public&nbsp;&lt;T&gt;&nbsp;T&nbsp;expectMsgEquals(Duration&nbsp;max,&nbsp;T&nbsp;msg)</span></tt></p>
<p>The given message object must be received within the specified time; the
object will be returned.</p>
</li>
<li><p class="first"><tt class="xref py py-meth docutils literal"><span class="pre">public&nbsp;Object&nbsp;expectMsgAnyOf(Duration&nbsp;max,&nbsp;Object...&nbsp;msg)</span></tt></p>
<p>An object must be received within the given time, and it must be equal
(compared with <tt class="docutils literal"><span class="pre">equals()</span></tt>) to at least one of the passed reference
objects; the received object will be returned.</p>
</li>
<li><p class="first"><tt class="xref py py-meth docutils literal"><span class="pre">public&nbsp;Object[]&nbsp;expectMsgAllOf(Duration&nbsp;max,&nbsp;Object...&nbsp;msg)</span></tt></p>
<p>A number of objects matching the size of the supplied object array must be
received within the given time, and for each of the given objects there
must exist at least one among the received ones which equals it (compared
with <tt class="docutils literal"><span class="pre">equals()</span></tt>). The full sequence of received objects is returned in
the order received.</p>
</li>
<li><p class="first"><tt class="xref py py-meth docutils literal"><span class="pre">public&nbsp;&lt;T&gt;&nbsp;T&nbsp;expectMsgClass(Duration&nbsp;max,&nbsp;Class&lt;T&gt;&nbsp;c)</span></tt></p>
<p>An object which is an instance of the given <tt class="xref py py-class docutils literal"><span class="pre">Class</span></tt> must be received
within the allotted time frame; the object will be returned. Note that this
does a conformance check, if you need the class to be equal you need to
verify that afterwards.</p>
</li>
<li><p class="first"><tt class="xref py py-meth docutils literal"><span class="pre">public&nbsp;&lt;T&gt;&nbsp;T&nbsp;expectMsgAnyClassOf(Duration&nbsp;max,&nbsp;Class&lt;?&nbsp;extends&nbsp;T&gt;...&nbsp;c)</span></tt></p>
<p>An object must be received within the given time, and it must be an
instance of at least one of the supplied <tt class="xref py py-class docutils literal"><span class="pre">Class</span></tt> objects; the
received object will be returned. Note that this does a conformance check,
if you need the class to be equal you need to verify that afterwards.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because of a limitation in Java’s type system it may be necessary to add
<tt class="docutils literal"><span class="pre">&#64;SuppressWarnings(&quot;unchecked&quot;)</span></tt> when using this method.</p>
</div>
</li>
<li><p class="first"><tt class="xref py py-meth docutils literal"><span class="pre">public&nbsp;void&nbsp;expectNoMsg(Duration&nbsp;max)</span></tt></p>
<p>No message must be received within the given time. This also fails if a
message has been received before calling this method which has not been
removed from the queue using one of the other methods.</p>
</li>
<li><p class="first"><tt class="xref py py-meth docutils literal"><span class="pre">Object[]&nbsp;receiveN(int&nbsp;n,&nbsp;Duration&nbsp;max)</span></tt></p>
<p><tt class="docutils literal"><span class="pre">n</span></tt> messages must be received within the given time; the received
messages are returned.</p>
</li>
</ul>
</div></blockquote>
<p>For cases which require more refined conditions there are constructs which take
code blocks:</p>
<blockquote>
<div><ul>
<li><p class="first"><strong>ExpectMsg&lt;T&gt;</strong></p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="k">final</span> <span class="nc">String</span> <span class="n">out</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ExpectMsg</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="s">&quot;match hint&quot;</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// do not put code outside this method, will run afterwards</span>
      <span class="k">protected</span> <span class="nc">String</span> <span class="k">match</span><span class="o">(</span><span class="nc">Object</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="n">instanceof</span> <span class="nc">Integer</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="s">&quot;match&quot;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">noMatch</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}.</span><span class="n">get</span><span class="o">();</span> <span class="c1">// this extracts the received message</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;match&quot;</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>The <tt class="xref py py-meth docutils literal"><span class="pre">match(Object&nbsp;in)</span></tt> method will be evaluated once a message has
been received within the allotted time (which may be given as constructor
argument). If it throws <tt class="docutils literal"><span class="pre">noMatch()</span></tt> (where it is sufficient to call that
method; the <tt class="docutils literal"><span class="pre">throw</span></tt> keyword is only needed in cases where the compiler
would otherwise complain about wrong return types—Java is lacking Scala’s
notion of a type which signifies “will not ever return normally”), then the
expectation fails with an <tt class="xref py py-class docutils literal"><span class="pre">AssertionError</span></tt>, otherwise the matched
and possibly transformed object is stored for retrieval using the
<tt class="xref py py-meth docutils literal"><span class="pre">get</span></tt> method.</p>
</li>
<li><p class="first"><strong>ReceiveWhile&lt;T&gt;</strong></p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="mi">43</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="k">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">out</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">ReceiveWhile</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// do not put code outside this method, will run afterwards</span>
      <span class="k">protected</span> <span class="nc">String</span> <span class="k">match</span><span class="o">(</span><span class="nc">Object</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="n">instanceof</span> <span class="nc">Integer</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">in</span><span class="o">.</span><span class="n">toString</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">noMatch</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}.</span><span class="n">get</span><span class="o">();</span> <span class="c1">// this extracts the received messages</span>
  <span class="n">assertArrayEquals</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]</span> <span class="o">{</span><span class="s">&quot;42&quot;</span><span class="o">,</span> <span class="s">&quot;43&quot;</span><span class="o">},</span> <span class="n">out</span><span class="o">);</span>
  <span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>This construct works like ExpectMsg, but it continually collects messages
as long as they match the criteria, and it does not fail when a
non-matching one is encountered. Collecting messages also ends when the
time is up, when too much time passes between messages or when enough
messages have been received.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">ReceiveWhile</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span>     <span class="c1">// type of array to be created must match ...</span>
      <span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span>           <span class="c1">// ... this class which is needed to that end</span>
      <span class="n">duration</span><span class="o">(</span><span class="s">&quot;100 millis&quot;</span><span class="o">),</span> <span class="c1">// maximum collect time</span>
      <span class="n">duration</span><span class="o">(</span><span class="s">&quot;50 millis&quot;</span><span class="o">),</span>  <span class="c1">// maximum time between messages</span>
      <span class="mi">12</span>                      <span class="c1">// maximum number of messages to collect</span>
      <span class="o">)</span> <span class="o">{</span>
  <span class="c1">// match elided ...</span>
<span class="o">};</span>
</pre></div>
</div>
<p>The need to specify the <tt class="docutils literal"><span class="pre">String</span></tt> result type twice results from the need
to create a correctly typed array and Java’s inability to infer the class’s
type argument.</p>
</li>
<li><p class="first"><strong>AwaitCond</strong></p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="k">new</span> <span class="nc">AwaitCond</span><span class="o">(</span>
        <span class="n">duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">),</span>  <span class="c1">// maximum wait time</span>
        <span class="n">duration</span><span class="o">(</span><span class="s">&quot;100 millis&quot;</span><span class="o">)</span> <span class="c1">// interval at which to check the condition</span>
        <span class="o">)</span> <span class="o">{</span>
    <span class="c1">// do not put code outside this method, will run afterwards</span>
    <span class="k">protected</span> <span class="n">boolean</span> <span class="n">cond</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// typically used to wait for something to start up</span>
      <span class="k">return</span> <span class="n">msgAvailable</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">};</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>This general construct is not connected with the test kit’s message
reception, the embedded condition can compute the boolean result from
anything in scope.</p>
<ul class="simple">
<li><strong>AwaitAssert</strong></li>
</ul>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="k">new</span> <span class="nc">AwaitAssert</span><span class="o">(</span>
        <span class="n">duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">),</span>  <span class="c1">// maximum wait time</span>
        <span class="n">duration</span><span class="o">(</span><span class="s">&quot;100 millis&quot;</span><span class="o">)</span> <span class="c1">// interval at which to check the condition</span>
        <span class="o">)</span> <span class="o">{</span>
    <span class="c1">// do not put code outside this method, will run afterwards</span>
    <span class="k">protected</span> <span class="n">void</span> <span class="n">check</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">assertEquals</span><span class="o">(</span><span class="n">msgAvailable</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">};</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>This general construct is not connected with the test kit’s message
reception, the embedded assert can check anything in scope.</p>
</li>
</ul>
</div></blockquote>
<p>There are also cases where not all messages sent to the test kit are actually
relevant to the test, but removing them would mean altering the actors under
test. For this purpose it is possible to ignore certain messages:</p>
<blockquote>
<div><ul>
<li><p class="first"><strong>IgnoreMsg</strong></p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="c1">// ignore all Strings</span>
  <span class="k">new</span> <span class="nc">IgnoreMsg</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">protected</span> <span class="n">boolean</span> <span class="n">ignore</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">msg</span> <span class="n">instanceof</span> <span class="nc">String</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">};</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">expectMsgEquals</span><span class="o">(</span><span class="mi">42</span><span class="o">);</span>
  <span class="c1">// remove message filter</span>
  <span class="n">ignoreNoMsg</span><span class="o">();</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
<span class="o">}};</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="expecting-log-messages">
<h3>Expecting Log Messages</h3>
<p>Since an integration test does not allow to the internal processing of the
participating actors, verifying expected exceptions cannot be done directly.
Instead, use the logging system for this purpose: replacing the normal event
handler with the <tt class="xref py py-class docutils literal"><span class="pre">TestEventListener</span></tt> and using an <tt class="xref py py-class docutils literal"><span class="pre">EventFilter</span></tt>
allows assertions on log messages, including those which are generated by
exceptions:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;TestKitDocTest&quot;</span><span class="o">,</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="o">());</span>
  <span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">victim</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">.</span><span class="n">empty</span><span class="o">(),</span> <span class="s">&quot;victim&quot;</span><span class="o">);</span>

  <span class="k">final</span> <span class="n">int</span> <span class="n">result</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">EventFilter</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;(</span><span class="nc">ActorKilledException</span><span class="o">.</span><span class="n">class</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">protected</span> <span class="nc">Integer</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">victim</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">Kill</span><span class="o">.</span><span class="n">getInstance</span><span class="o">(),</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
      <span class="k">return</span> <span class="mi">42</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}.</span><span class="n">from</span><span class="o">(</span><span class="s">&quot;akka://TestKitDocTest/user/victim&quot;</span><span class="o">).</span><span class="n">occurrences</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">exec</span><span class="o">();</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>If a number of occurrences is specific—as demonstrated above—then <tt class="docutils literal"><span class="pre">exec()</span></tt>
will block until that number of matching messages have been received or the
timeout configured in <tt class="docutils literal"><span class="pre">akka.test.filter-leeway</span></tt> is used up (time starts
counting after the <tt class="docutils literal"><span class="pre">run()</span></tt> method returns). In case of a timeout the test
fails.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Be sure to exchange the default logger with the
<tt class="xref py py-class docutils literal"><span class="pre">TestEventListener</span></tt> in your <tt class="docutils literal"><span class="pre">application.conf</span></tt> to enable this
function:</p>
<div class="last highlight-scala"><div class="highlight"><pre><span class="n">akka</span><span class="o">.</span><span class="n">loggers</span> <span class="k">=</span> <span class="o">[</span><span class="kt">akka.testkit.TestEventListener</span><span class="o">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="timing-assertions">
<span id="javatestkit-within"></span><h3>Timing Assertions</h3>
<p>Another important part of functional testing concerns timing: certain events
must not happen immediately (like a timer), others need to happen before a
deadline. Therefore, all examination methods accept an upper time limit within
the positive or negative result must be obtained. Lower time limits need to be
checked external to the examination, which is facilitated by a new construct
for managing time constraints:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="k">new</span> <span class="nc">Within</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="nc">Zero</span><span class="o">(),</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;second&quot;</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">// do not put code outside this method, will run afterwards</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">assertEquals</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span> <span class="mi">42</span><span class="o">,</span> <span class="n">expectMsgClass</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="n">class</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">};</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>The block in <tt class="xref py py-meth docutils literal"><span class="pre">Within.run</span></tt> must complete after a <a class="reference internal" href="../common/duration.html#duration"><em>Duration</em></a> which
is between <tt class="xref py py-obj docutils literal"><span class="pre">min</span></tt> and <tt class="xref py py-obj docutils literal"><span class="pre">max</span></tt>, where the former defaults to zero. The
deadline calculated by adding the <tt class="xref py py-obj docutils literal"><span class="pre">max</span></tt> parameter to the block's start
time is implicitly available within the block to all examination methods, if
you do not specify it, it is inherited from the innermost enclosing
<tt class="xref py py-meth docutils literal"><span class="pre">within</span></tt> block.</p>
<p>It should be noted that if the last message-receiving assertion of the block is
<tt class="xref py py-meth docutils literal"><span class="pre">expectNoMsg</span></tt> or <tt class="xref py py-meth docutils literal"><span class="pre">receiveWhile</span></tt>, the final check of the
<tt class="xref py py-meth docutils literal"><span class="pre">within</span></tt> is skipped in order to avoid false positives due to wake-up
latencies. This means that while individual contained assertions still use the
maximum time bound, the overall block may take arbitrarily longer in this case.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All times are measured using <tt class="docutils literal"><span class="pre">System.nanoTime</span></tt>, meaning that they describe
wall time, not CPU time or system time.</p>
</div>
<div class="section" id="accounting-for-slow-test-systems">
<h4>Accounting for Slow Test Systems</h4>
<p>The tight timeouts you use during testing on your lightning-fast notebook will
invariably lead to spurious test failures on the heavily loaded Jenkins server
(or similar). To account for this situation, all maximum durations are
internally scaled by a factor taken from the <a class="reference internal" href="../general/configuration.html#configuration"><em>Configuration</em></a>,
<tt class="docutils literal"><span class="pre">akka.test.timefactor</span></tt>, which defaults to 1.</p>
<p>You can scale other durations with the same factor by using the implicit conversion
in <tt class="docutils literal"><span class="pre">akka.testkit</span></tt> package object to add dilated function to <tt class="xref py py-class docutils literal"><span class="pre">Duration</span></tt>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="k">final</span> <span class="nc">Duration</span> <span class="n">original</span> <span class="k">=</span> <span class="n">duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">);</span>
  <span class="k">final</span> <span class="nc">Duration</span> <span class="n">stretched</span> <span class="k">=</span> <span class="n">dilated</span><span class="o">(</span><span class="n">original</span><span class="o">);</span>
  <span class="n">assertTrue</span><span class="o">(</span><span class="s">&quot;dilated&quot;</span><span class="o">,</span> <span class="n">stretched</span><span class="o">.</span><span class="n">gteq</span><span class="o">(</span><span class="n">original</span><span class="o">));</span>
<span class="o">}};</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-multiple-probe-actors">
<h3>Using Multiple Probe Actors</h3>
<p>When the actors under test are supposed to send various messages to different
destinations, it may be difficult distinguishing the message streams arriving
at the <tt class="xref py py-obj docutils literal"><span class="pre">testActor</span></tt> when using the <tt class="xref py py-class docutils literal"><span class="pre">JavaTestKit</span></tt> as shown until now.
Another approach is to use it for creation of simple probe actors to be
inserted in the message flows. The functionality is best explained using a
small example:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="c1">// simple actor which just forwards messages</span>
  <span class="k">class</span> <span class="nc">Forwarder</span> <span class="k">extends</span> <span class="nc">UntypedActor</span> <span class="o">{</span>
    <span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">target</span><span class="o">;</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unused&quot;</span><span class="o">)</span>
    <span class="n">public</span> <span class="nc">Forwarder</span><span class="o">(</span><span class="nc">ActorRef</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="n">target</span> <span class="k">=</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">target</span><span class="o">.</span><span class="n">forward</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">getContext</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="c1">// create a test probe</span>
  <span class="k">final</span> <span class="nc">JavaTestKit</span> <span class="n">probe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>

  <span class="c1">// create a forwarder, injecting the probe’s testActor</span>
  <span class="k">final</span> <span class="nc">Props</span> <span class="n">props</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">Forwarder</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="n">getRef</span><span class="o">());</span>
  <span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">forwarder</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="s">&quot;forwarder&quot;</span><span class="o">);</span>

  <span class="c1">// verify correct forwarding</span>
  <span class="n">forwarder</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="n">getRef</span><span class="o">());</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">expectMsgEquals</span><span class="o">(</span><span class="mi">42</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="n">getRef</span><span class="o">(),</span> <span class="n">probe</span><span class="o">.</span><span class="n">getLastSender</span><span class="o">());</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>This simple test verifies an equally simple Forwarder actor by injecting a
probe as the forwarder’s target.  Another example would be two actors A and B
which collaborate by A sending messages to B. In order to verify this message
flow, a <tt class="xref py py-class docutils literal"><span class="pre">TestProbe</span></tt> could be inserted as target of A, using the
forwarding capabilities or auto-pilot described below to include a real B in
the test setup.</p>
<p>Probes may also be equipped with custom assertions to make your test code even
more concise and clear:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="k">class</span> <span class="nc">MyProbe</span> <span class="k">extends</span> <span class="nc">JavaTestKit</span> <span class="o">{</span>
    <span class="n">public</span> <span class="nc">MyProbe</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">super</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">assertHello</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">final</span> <span class="nc">MyProbe</span> <span class="n">probe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MyProbe</span><span class="o">();</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">assertHello</span><span class="o">();</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>You have complete flexibility here in mixing and matching the
<tt class="xref py py-class docutils literal"><span class="pre">JavaTestKit</span></tt> facilities with your own checks and choosing an intuitive
name for it. In real life your code will probably be a bit more complicated
than the example given above; just use the power!</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Any message send from a <tt class="docutils literal"><span class="pre">TestProbe</span></tt> to another actor which runs on the
CallingThreadDispatcher runs the risk of dead-lock, if that other actor might
also send to this probe. The implementation of <tt class="xref py py-meth docutils literal"><span class="pre">TestProbe.watch</span></tt> and
<tt class="xref py py-meth docutils literal"><span class="pre">TestProbe.unwatch</span></tt> will also send a message to the watchee, which
means that it is dangerous to try watching e.g. <tt class="xref py py-class docutils literal"><span class="pre">TestActorRef</span></tt> from a
<tt class="xref py py-meth docutils literal"><span class="pre">TestProbe</span></tt>.</p>
</div>
<div class="section" id="watching-other-actors-from-probes">
<h4>Watching Other Actors from Probes</h4>
<p>A <tt class="xref py py-class docutils literal"><span class="pre">JavaTestKit</span></tt> can register itself for DeathWatch of any other actor:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="k">final</span> <span class="nc">JavaTestKit</span> <span class="n">probe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">watch</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
  <span class="n">target</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="nc">PoisonPill</span><span class="o">.</span><span class="n">getInstance</span><span class="o">(),</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="k">final</span> <span class="nc">Terminated</span> <span class="n">msg</span> <span class="k">=</span> <span class="n">probe</span><span class="o">.</span><span class="n">expectMsgClass</span><span class="o">(</span><span class="nc">Terminated</span><span class="o">.</span><span class="n">class</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="n">getActor</span><span class="o">(),</span> <span class="n">target</span><span class="o">);</span>
<span class="o">}};</span>
</pre></div>
</div>
</div>
<div class="section" id="replying-to-messages-received-by-probes">
<h4>Replying to Messages Received by Probes</h4>
<p>The probe stores the sender of the last dequeued message (i.e. after its
<tt class="docutils literal"><span class="pre">expectMsg*</span></tt> reception), which may be retrieved using the
<tt class="xref py py-meth docutils literal"><span class="pre">getLastSender</span></tt> method. This information can also implicitly be used
for having the probe reply to the last received message:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="k">final</span> <span class="nc">JavaTestKit</span> <span class="n">probe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="n">getRef</span><span class="o">());</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">reply</span><span class="o">(</span><span class="s">&quot;world&quot;</span><span class="o">);</span>
  <span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;world&quot;</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="n">probe</span><span class="o">.</span><span class="n">getRef</span><span class="o">(),</span> <span class="n">getLastSender</span><span class="o">());</span>
<span class="o">}};</span>
</pre></div>
</div>
</div>
<div class="section" id="forwarding-messages-received-by-probes">
<h4>Forwarding Messages Received by Probes</h4>
<p>The probe can also forward a received message (i.e. after its <tt class="docutils literal"><span class="pre">expectMsg*</span></tt>
reception), retaining the original sender:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="k">final</span> <span class="nc">JavaTestKit</span> <span class="n">probe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="n">getRef</span><span class="o">());</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">forward</span><span class="o">(</span><span class="n">getRef</span><span class="o">());</span>
  <span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
  <span class="n">assertEquals</span><span class="o">(</span><span class="n">getRef</span><span class="o">(),</span> <span class="n">getLastSender</span><span class="o">());</span>
<span class="o">}};</span>
</pre></div>
</div>
</div>
<div class="section" id="auto-pilot">
<h4>Auto-Pilot</h4>
<p>Receiving messages in a queue for later inspection is nice, but in order to
keep a test running and verify traces later you can also install an
<tt class="xref py py-class docutils literal"><span class="pre">AutoPilot</span></tt> in the participating test probes (actually in any
<tt class="xref py py-class docutils literal"><span class="pre">TestKit</span></tt>) which is invoked before enqueueing to the inspection queue.
This code can be used to forward messages, e.g. in a chain <tt class="docutils literal"><span class="pre">A</span> <span class="pre">--&gt;</span> <span class="pre">Probe</span> <span class="pre">--&gt;</span>
<span class="pre">B</span></tt>, as long as a certain protocol is obeyed.</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="k">final</span> <span class="nc">JavaTestKit</span> <span class="n">probe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
  <span class="c1">// install auto-pilot</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">setAutoPilot</span><span class="o">(</span><span class="k">new</span> <span class="nc">TestActor</span><span class="o">.</span><span class="nc">AutoPilot</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">public</span> <span class="nc">AutoPilot</span> <span class="n">run</span><span class="o">(</span><span class="nc">ActorRef</span> <span class="n">sender</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">sender</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
      <span class="k">return</span> <span class="n">noAutoPilot</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">});</span>
  <span class="c1">// first one is replied to directly ...</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">,</span> <span class="n">getRef</span><span class="o">());</span>
  <span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
  <span class="c1">// ... but then the auto-pilot switched itself off</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">getRef</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;world&quot;</span><span class="o">,</span> <span class="n">getRef</span><span class="o">());</span>
  <span class="n">expectNoMsg</span><span class="o">();</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>The <tt class="xref py py-meth docutils literal"><span class="pre">run</span></tt> method must return the auto-pilot for the next message, wrapped
in an <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt>; setting it to <tt class="xref py py-obj docutils literal"><span class="pre">None</span></tt> terminates the auto-pilot.</p>
</div>
<div class="section" id="caution-about-timing-assertions">
<h4>Caution about Timing Assertions</h4>
<p>The behavior of <tt class="xref py py-meth docutils literal"><span class="pre">within</span></tt> blocks when using test probes might be perceived
as counter-intuitive: you need to remember that the nicely scoped deadline as
described <a class="reference internal" href="#javatestkit-within"><em>above</em></a> is local to each probe. Hence, probes
do not react to each other's deadlines or to the deadline set in an enclosing
<tt class="xref py py-class docutils literal"><span class="pre">JavaTestKit</span></tt> instance:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">)</span> <span class="o">{{</span>
  <span class="k">final</span> <span class="nc">JavaTestKit</span> <span class="n">probe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JavaTestKit</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
  <span class="k">new</span> <span class="nc">Within</span><span class="o">(</span><span class="n">duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">probe</span><span class="o">.</span><span class="n">expectMsgEquals</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">};</span>
<span class="o">}};</span>
</pre></div>
</div>
<p>Here, the <tt class="docutils literal"><span class="pre">expectMsgEquals</span></tt> call will use the default timeout.</p>
</div>
</div>
</div>
<div class="section" id="callingthreaddispatcher">
<span id="java-callingthreaddispatcher"></span><h2>CallingThreadDispatcher</h2>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">CallingThreadDispatcher</span></tt> serves good purposes in unit testing, as
described above, but originally it was conceived in order to allow contiguous
stack traces to be generated in case of an error. As this special dispatcher
runs everything which would normally be queued directly on the current thread,
the full history of a message's processing chain is recorded on the call stack,
so long as all intervening actors run on this dispatcher.</p>
<div class="section" id="how-to-use-it">
<h3>How to use it</h3>
<p>Just set the dispatcher as you normally would:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
  <span class="nc">Props</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="nc">MyActor</span><span class="o">.</span><span class="n">class</span><span class="o">)</span>
    <span class="o">.</span><span class="n">withDispatcher</span><span class="o">(</span><span class="nc">CallingThreadDispatcher</span><span class="o">.</span><span class="nc">Id</span><span class="o">()));</span>
</pre></div>
</div>
</div>
<div class="section" id="how-it-works">
<h3>How it works</h3>
<p>When receiving an invocation, the <tt class="xref py py-class docutils literal"><span class="pre">CallingThreadDispatcher</span></tt> checks
whether the receiving actor is already active on the current thread. The
simplest example for this situation is an actor which sends a message to
itself. In this case, processing cannot continue immediately as that would
violate the actor model, so the invocation is queued and will be processed when
the active invocation on that actor finishes its processing; thus, it will be
processed on the calling thread, but simply after the actor finishes its
previous work. In the other case, the invocation is simply processed
immediately on the current thread. Futures scheduled via this dispatcher are
also executed immediately.</p>
<p>This scheme makes the <tt class="xref py py-class docutils literal"><span class="pre">CallingThreadDispatcher</span></tt> work like a general
purpose dispatcher for any actors which never block on external events.</p>
<p>In the presence of multiple threads it may happen that two invocations of an
actor running on this dispatcher happen on two different threads at the same
time. In this case, both will be processed directly on their respective
threads, where both compete for the actor's lock and the loser has to wait.
Thus, the actor model is left intact, but the price is loss of concurrency due
to limited scheduling. In a sense this is equivalent to traditional mutex style
concurrency.</p>
<p>The other remaining difficulty is correct handling of suspend and resume: when
an actor is suspended, subsequent invocations will be queued in thread-local
queues (the same ones used for queuing in the normal case). The call to
<tt class="xref py py-meth docutils literal"><span class="pre">resume</span></tt>, however, is done by one specific thread, and all other threads
in the system will probably not be executing this specific actor, which leads
to the problem that the thread-local queues cannot be emptied by their native
threads. Hence, the thread calling <tt class="xref py py-meth docutils literal"><span class="pre">resume</span></tt> will collect all currently
queued invocations from all threads into its own queue and process them.</p>
</div>
<div class="section" id="limitations">
<h3>Limitations</h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In case the CallingThreadDispatcher is used for top-level actors, but
without going through TestActorRef, then there is a time window during which
the actor is awaiting construction by the user guardian actor. Sending
messages to the actor during this time period will result in them being
enqueued and then executed on the guardian’s thread instead of the caller’s
thread. To avoid this, use TestActorRef.</p>
</div>
<p>If an actor's behavior blocks on a something which would normally be affected
by the calling actor after having sent the message, this will obviously
dead-lock when using this dispatcher. This is a common scenario in actor tests
based on <tt class="xref py py-class docutils literal"><span class="pre">CountDownLatch</span></tt> for synchronization:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="k">val</span> <span class="n">latch</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="n">actor</span> <span class="o">!</span> <span class="n">startWorkAfter</span><span class="o">(</span><span class="n">latch</span><span class="o">)</span>   <span class="c1">// actor will call latch.await() before proceeding</span>
<span class="n">doSomeSetupStuff</span><span class="o">()</span>
<span class="n">latch</span><span class="o">.</span><span class="n">countDown</span><span class="o">()</span>
</pre></div>
</div>
<p>The example would hang indefinitely within the message processing initiated on
the second line and never reach the fourth line, which would unblock it on a
normal dispatcher.</p>
<p>Thus, keep in mind that the <tt class="xref py py-class docutils literal"><span class="pre">CallingThreadDispatcher</span></tt> is not a
general-purpose replacement for the normal dispatchers. On the other hand it
may be quite useful to run your actor network on it for testing, because if it
runs without dead-locking chances are very high that it will not dead-lock in
production.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The above sentence is unfortunately not a strong guarantee, because your
code might directly or indirectly change its behavior when running on a
different dispatcher. If you are looking for a tool to help you debug
dead-locks, the <tt class="xref py py-class docutils literal"><span class="pre">CallingThreadDispatcher</span></tt> may help with certain error
scenarios, but keep in mind that it has may give false negatives as well as
false positives.</p>
</div>
</div>
<div class="section" id="thread-interruptions">
<h3>Thread Interruptions</h3>
<p>If the CallingThreadDispatcher sees that the current thread has its
<tt class="docutils literal"><span class="pre">isInterrupted()</span></tt> flag set when message processing returns, it will throw an
<tt class="xref py py-class docutils literal"><span class="pre">InterruptedException</span></tt> after finishing all its processing (i.e. all
messages which need processing as described above are processed before this
happens). As <tt class="xref py py-meth docutils literal"><span class="pre">tell</span></tt> cannot throw exceptions due to its contract, this
exception will then be caught and logged, and the thread’s interrupted status
will be set again.</p>
<p>If during message processing an <tt class="xref py py-class docutils literal"><span class="pre">InterruptedException</span></tt> is thrown then it
will be caught inside the CallingThreadDispatcher’s message handling loop, the
thread’s interrupted flag will be set and processing continues normally.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The summary of these two paragraphs is that if the current thread is
interrupted while doing work under the CallingThreadDispatcher, then that
will result in the <tt class="docutils literal"><span class="pre">isInterrupted</span></tt> flag to be <tt class="docutils literal"><span class="pre">true</span></tt> when the message
send returns and no <tt class="xref py py-class docutils literal"><span class="pre">InterruptedException</span></tt> will be thrown.</p>
</div>
</div>
<div class="section" id="benefits">
<h3>Benefits</h3>
<p>To summarize, these are the features with the <tt class="xref py py-class docutils literal"><span class="pre">CallingThreadDispatcher</span></tt>
has to offer:</p>
<blockquote>
<div><ul class="simple">
<li>Deterministic execution of single-threaded tests while retaining nearly full
actor semantics</li>
<li>Full message processing history leading up to the point of failure in
exception stack traces</li>
<li>Exclusion of certain classes of dead-lock scenarios</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="tracing-actor-invocations">
<span id="actor-logging-java"></span><h2>Tracing Actor Invocations</h2>
<p>The testing facilities described up to this point were aiming at formulating
assertions about a system’s behavior. If a test fails, it is usually your job
to find the cause, fix it and verify the test again. This process is supported
by debuggers as well as logging, where the Akka toolkit offers the following
options:</p>
<ul>
<li><p class="first"><em>Logging of exceptions thrown within Actor instances</em></p>
<p>This is always on; in contrast to the other logging mechanisms, this logs at
<tt class="docutils literal"><span class="pre">ERROR</span></tt> level.</p>
</li>
<li><p class="first"><em>Logging of special messages</em></p>
<p>Actors handle certain special messages automatically, e.g. <tt class="xref py py-obj docutils literal"><span class="pre">Kill</span></tt>,
<tt class="xref py py-obj docutils literal"><span class="pre">PoisonPill</span></tt>, etc. Tracing of these message invocations is enabled by
the setting <tt class="docutils literal"><span class="pre">akka.actor.debug.autoreceive</span></tt>, which enables this on all
actors.</p>
</li>
<li><p class="first"><em>Logging of the actor lifecycle</em></p>
<p>Actor creation, start, restart, monitor start, monitor stop and stop may be traced by
enabling the setting <tt class="docutils literal"><span class="pre">akka.actor.debug.lifecycle</span></tt>; this, too, is enabled
uniformly on all actors.</p>
</li>
</ul>
<p>All these messages are logged at <tt class="docutils literal"><span class="pre">DEBUG</span></tt> level. To summarize, you can enable
full logging of actor activities using this configuration fragment:</p>
<div class="highlight-scala"><div class="highlight"><pre><span class="n">akka</span> <span class="o">{</span>
  <span class="n">loglevel</span> <span class="k">=</span> <span class="s">&quot;DEBUG&quot;</span>
  <span class="n">actor</span> <span class="o">{</span>
    <span class="n">debug</span> <span class="o">{</span>
      <span class="n">autoreceive</span> <span class="k">=</span> <span class="n">on</span>
      <span class="n">lifecycle</span> <span class="k">=</span> <span class="n">on</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://akka.io/faq">FAQ</a></li>
      <li><a href="http://typesafe.com/stack/downloads/akka">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>      
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>      
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://typesafe.com/products/typesafe-subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@typesafe.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/watermark.png" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2013 <a href="http://typesafe.com/">Typesafe Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: Feb 22, 2014
    </p>          
  </div>
</div>
<script type="text/javascript">
  $('#toc').toc();
</script>
  

  </body>
</html>